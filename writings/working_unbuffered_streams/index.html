<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Lukas Knuth"><meta name=description content="When working with I/O in Java, you can normally choose from a variety of Stream and Reader or Writer classes to handle all the &amp;ldquo;dirty&amp;rdquo; work for you. But what happens under the hood? And why is this stuff so error-prone?"><meta property="og:description" value="When working with I/O in Java, you can normally choose from a variety of Stream and Reader or Writer classes to handle all the &amp;ldquo;dirty&amp;rdquo; work for you. But what happens under the hood? And why is this stuff so error-prone?"><meta property="og:title" value="Working unbuffered Streams"><meta property="og:url" value=https://lknuth.dev/writings/working_unbuffered_streams/><meta property="og:type" value=article><meta property="og:article:author" value="Lukas Knuth"><meta property="og:article:published_time" value=2012-10-15T15:54:32+0100><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><title>Working unbuffered Streams | Lukas Knuth</title>
<link rel="stylesheet" href="/css/main.min.8e36eaaa6e050f395053719e62d46372876b276b94ce8375fab4aea4e8528a1e.css" integrity="sha256-jjbqqm4FDzlQU3GeYtRjcodrJ2uUzoN1+rSupOhSih4=" crossorigin="anonymous">
<link rel=canonical href=https://lknuth.dev/writings/working_unbuffered_streams/><link rel=icon type=image/png href=https://lknuth.dev/images/favicon-96x96.png sizes=96x96><link rel=icon type=image/svg+xml href=https://lknuth.dev/images/favicon.svg><link rel="shortcut icon" href=https://lknuth.dev/images/favicon.ico><link rel=alternate type=application/rss+xml href=https://lknuth.dev/writings/index.xml title=Writings></head><body id=very-top class="flex flex-col h-screen max-w-6xl container mx-auto bg-pane break-words text-base text-writing md:text-lg antialiased hyphens-auto leading-relaxed font-sans"><header><div class="h-spaced mt-4 md:mt-6 mb-3"><a href=https://lknuth.dev/><div class="w-16 h-16 mr-3 md:mr-5 float-left bg-no-repeat bg-center bg-contain rounded-md" style=background-image:url(https://lknuth.dev/images/favicon.svg)></div><div class="hidden md:!block text-3xl font-bold"><span>Lukas Knuth</span><span class="pl-1 pr-3 tracking-[-0.3em]">//</span><span>Software Engineer</span></div><div class="md:hidden text-xl font-bold truncate text-clip"><span>Lukas Knuth</span><span class="pl-1 pr-2 tracking-[-0.3em]">//</span><span>SWE</span></div></a><nav><ol class="flex text-primary pt-1"><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/writings>Writings</a></li><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/about>About</a></li><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/cv>CV</a></li><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/now>Now</a></li></ol></nav></div></header><main class=grow><article class="h-spaced mt-4 md:mt-6" itemscope itemtype=http://schema.org/BlogPosting><h1 class="text-3xl font-light text-subtle" itemprop="name headline">Working unbuffered Streams</h1><div class="my-2 text-sm text-subtle"><time datetime="2012-10-15 15:54:32 +0100 +0100" itemprop=datePublished>2012-10-15</time></div><div class=prose itemprop=articleBody><p>When working with I/O in Java, you can normally choose from a variety of <code>Stream</code> and <code>Reader</code> or <code>Writer</code> classes to handle all the &ldquo;dirty&rdquo; work for you. But what happens under the hood? And why is this stuff so error-prone?</p><h2 id=being-the-buffer><a href=#being-the-buffer>Being the buffer</a></h2><p>When reading/writing binary data, for example from a <code>Socket</code> or a file, you should use a <a href=https://docs.oracle.com/javase/7/docs/api/java/io/BufferedOutputStream.html rel=external><code>BufferedOutputStream</code></a>. But what if you couldn&rsquo;t?</p><p>Lets implement a simple binary copy ourselfs:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic>// This code is intended to be incorrect. DON&#39;T COPY THIS!</span>
</span></span><span style=display:flex><span><span style=color:#d20f39>byte</span> buffer<span style=color:#04a5e5;font-weight:700>[]</span> <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> <span style=color:#d20f39>byte</span><span style=color:#04a5e5;font-weight:700>[</span>1024<span style=color:#04a5e5;font-weight:700>]</span>;
</span></span><span style=display:flex><span><span style=color:#8839ef>while</span> (input.<span style=color:#1e66f5>read</span>(buffer, 0, buffer.<span style=color:#1e66f5>length</span>) <span style=color:#04a5e5;font-weight:700>!=</span> <span style=color:#04a5e5;font-weight:700>-</span>1) {
</span></span><span style=display:flex><span>    output.<span style=color:#1e66f5>write</span>(buffer, 0, buffer.<span style=color:#1e66f5>length</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Can you spot the problem in the snippet? It&rsquo;s subtle. What makes it worse is that (under the correct conditions) the result <em>can</em> be perfectly correct. Never the less, this code has a bug!</p><h3 id=the-full-buffer-lie><a href=#the-full-buffer-lie>The &ldquo;full buffer&rdquo; lie</a></h3><p>The problem with the code above is on line 4, the one that reads <code>output.write(buffer, 0, buffer.length)</code>. The code assumes that the buffer is always completely filled, which is not necessarily the case! The <a href=http://docs.oracle.com/javase/6/docs/api/java/io/InputStream.html#read%28byte[],%20int,%20int%29 rel=external>documentation for <code>InputStream.read(byte[], int, int)</code> states</a>:</p><blockquote><p><strong>Reads <u>up to</u> <code>len</code> bytes of data from the input stream</strong> into an array of bytes. <strong>An attempt is made to
read as many as <code>len</code> bytes, but a smaller number may be read.</strong> The number of bytes actually read is returned
as an integer. [&mldr;]</p></blockquote><p>So, the buffer is not guaranteed to be full. This becomes a problem when we use the <code>OutputStream.write(byte[], int, int)</code>-method to write the read bytes to the output stream. It&rsquo;s <a href=http://docs.oracle.com/javase/6/docs/api/java/io/OutputStream.html#write%28byte[],%20int,%20int%29 rel=external>documentation reads</a>:</p><blockquote><p><strong>Writes [exactly] <code>len</code> bytes</strong> from the specified byte array starting at offset <code>off</code> to this output stream. [&mldr;]</p></blockquote><p>Here, it&rsquo;s the other way around. When we call the method with a <code>len</code>-parameter of our byte-array size (which is and will always be 1024 in this example), the method will write exactly 1024 bytes.</p><p>Now, if the <code>read()</code>-method only read 300 bytes into the buffer and we tell the <code>write()</code>-method to write exactly 1024 bytes, the remaining 724 bytes will be filled up with null-bytes. Even worse, if we previously read 700 bytes of data into the buffer and the next call to <code>read()</code> only overwrote the first 300 bytes, the remaining 400 bytes from the previous <code>read()</code>-call will be written out again (along with another 324 null-bytes). Either case will lead to corrupted output.</p><h3 id=doing-it-right><a href=#doing-it-right>Doing it right</a></h3><p>So, how do we know how many bytes where read into the buffer? Quoting again from the <a href=http://docs.oracle.com/javase/6/docs/api/java/io/InputStream.html#read%28byte[],%20int,%20int%29 rel=external><code>InputStream.read(byte[], int, int)</code>-documentation</a>:</p><blockquote><p>[&mldr;] a smaller number may be read. <strong>The number of bytes actually read is returned as an integer.</strong></p></blockquote><p>In the above example, we already checked the return-value to see if we where at the end of the stream. Now, we&rsquo;ll store it and use it as the <code>len</code>-parameter for the <code>write()</code>-method:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d20f39>byte</span> buffer<span style=color:#04a5e5;font-weight:700>[]</span> <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> <span style=color:#d20f39>byte</span><span style=color:#04a5e5;font-weight:700>[</span>1024<span style=color:#04a5e5;font-weight:700>]</span>;
</span></span><span style=display:flex><span><span style=color:#d20f39>int</span> read_count <span style=color:#04a5e5;font-weight:700>=</span> 0;
</span></span><span style=display:flex><span><span style=color:#8839ef>while</span> ((read_count <span style=color:#04a5e5;font-weight:700>=</span> input.<span style=color:#1e66f5>read</span>(buffer, 0, buffer.<span style=color:#1e66f5>length</span>)) <span style=color:#04a5e5;font-weight:700>!=</span> <span style=color:#04a5e5;font-weight:700>-</span>1) {
</span></span><span style=display:flex><span>    output.<span style=color:#1e66f5>write</span>(buffer, 0, read_count); <span style=color:#9ca0b0;font-style:italic>// Now writes the correct amount of bytes</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This will write the exact amount of bytes read from the input-stream, into the output-stream.</p><h2 id=conclusion><a href=#conclusion>Conclusion</a></h2><ul><li>Keep track of the amount of bytes read from your input-stream.</li><li>Check to write the correct amount of bytes to your output-stream.</li><li>Use the <a href=https://docs.oracle.com/javase/7/docs/api/java/io/BufferedOutputStream.html rel=external><code>BufferedOutputStream</code></a> for binary data.</li><li>Use existing <a href=http://docs.oracle.com/javase/6/docs/api/java/io/Reader.html rel=external>Reader</a>/<a href=http://docs.oracle.com/javase/6/docs/api/java/io/Writer.html rel=external>Writer</a> implementations when handling String data.</li></ul></div></article><div class="mt-8 mb-3 py-4 px-5 md:px-9" style="background-image:url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 304 304' width='304' height='304'%3E%3Cpath fill='%23c8c8c8' fill-opacity='0.5' d='M44.1 224a5 5 0 1 1 0 2H0v-2h44.1zm160 48a5 5 0 1 1 0 2H82v-2h122.1zm57.8-46a5 5 0 1 1 0-2H304v2h-42.1zm0 16a5 5 0 1 1 0-2H304v2h-42.1zm6.2-114a5 5 0 1 1 0 2h-86.2a5 5 0 1 1 0-2h86.2zm-256-48a5 5 0 1 1 0 2H0v-2h12.1zm185.8 34a5 5 0 1 1 0-2h86.2a5 5 0 1 1 0 2h-86.2zM258 12.1a5 5 0 1 1-2 0V0h2v12.1zm-64 208a5 5 0 1 1-2 0v-54.2a5 5 0 1 1 2 0v54.2zm48-198.2V80h62v2h-64V21.9a5 5 0 1 1 2 0zm16 16V64h46v2h-48V37.9a5 5 0 1 1 2 0zm-128 96V208h16v12.1a5 5 0 1 1-2 0V210h-16v-76.1a5 5 0 1 1 2 0zm-5.9-21.9a5 5 0 1 1 0 2H114v48H85.9a5 5 0 1 1 0-2H112v-48h12.1zm-6.2 130a5 5 0 1 1 0-2H176v-74.1a5 5 0 1 1 2 0V242h-60.1zm-16-64a5 5 0 1 1 0-2H114v48h10.1a5 5 0 1 1 0 2H112v-48h-10.1zM66 284.1a5 5 0 1 1-2 0V274H50v30h-2v-32h18v12.1zM236.1 176a5 5 0 1 1 0 2H226v94h48v32h-2v-30h-48v-98h12.1zm25.8-30a5 5 0 1 1 0-2H274v44.1a5 5 0 1 1-2 0V146h-10.1zm-64 96a5 5 0 1 1 0-2H208v-80h16v-14h-42.1a5 5 0 1 1 0-2H226v18h-16v80h-12.1zm86.2-210a5 5 0 1 1 0 2H272V0h2v32h10.1zM98 101.9V146H53.9a5 5 0 1 1 0-2H96v-42.1a5 5 0 1 1 2 0zM53.9 34a5 5 0 1 1 0-2H80V0h2v34H53.9zm60.1 3.9V66H82v64H69.9a5 5 0 1 1 0-2H80V64h32V37.9a5 5 0 1 1 2 0zM101.9 82a5 5 0 1 1 0-2H128V37.9a5 5 0 1 1 2 0V82h-28.1zm16-64a5 5 0 1 1 0-2H146v44.1a5 5 0 1 1-2 0V18h-26.1zm102.2 270a5 5 0 1 1 0 2H98v14h-2v-16h124.1zM242 149.9V160h16v34h-16v62h48v48h-2v-46h-48v-66h16v-30h-16v-12.1a5 5 0 1 1 2 0zM53.9 18a5 5 0 1 1 0-2H64V2H48V0h18v18H53.9zm112 32a5 5 0 1 1 0-2H192V0h50v2h-48v48h-28.1zm-48-48a5 5 0 0 1-9.8-2h2.07a3 3 0 1 0 5.66 0H178v34h-18V21.9a5 5 0 1 1 2 0V32h14V2h-58.1zm0 96a5 5 0 1 1 0-2H137l32-32h39V21.9a5 5 0 1 1 2 0V66h-40.17l-32 32H117.9zm28.1 90.1a5 5 0 1 1-2 0v-76.51L175.59 80H224V21.9a5 5 0 1 1 2 0V82h-49.59L146 112.41v75.69zm16 32a5 5 0 1 1-2 0v-99.51L184.59 96H300.1a5 5 0 0 1 3.9-3.9v2.07a3 3 0 0 0 0 5.66v2.07a5 5 0 0 1-3.9-3.9H185.41L162 121.41v98.69zm-144-64a5 5 0 1 1-2 0v-3.51l48-48V48h32V0h2v50H66v55.41l-48 48v2.69zM50 53.9v43.51l-48 48V208h26.1a5 5 0 1 1 0 2H0v-65.41l48-48V53.9a5 5 0 1 1 2 0zm-16 16V89.41l-34 34v-2.82l32-32V69.9a5 5 0 1 1 2 0zM12.1 32a5 5 0 1 1 0 2H9.41L0 43.41V40.6L8.59 32h3.51zm265.8 18a5 5 0 1 1 0-2h18.69l7.41-7.41v2.82L297.41 50H277.9zm-16 160a5 5 0 1 1 0-2H288v-71.41l16-16v2.82l-14 14V210h-28.1zm-208 32a5 5 0 1 1 0-2H64v-22.59L40.59 194H21.9a5 5 0 1 1 0-2H41.41L66 216.59V242H53.9zm150.2 14a5 5 0 1 1 0 2H96v-56.6L56.6 162H37.9a5 5 0 1 1 0-2h19.5L98 200.6V256h106.1zm-150.2 2a5 5 0 1 1 0-2H80v-46.59L48.59 178H21.9a5 5 0 1 1 0-2H49.41L82 208.59V258H53.9zM34 39.8v1.61L9.41 66H0v-2h8.59L32 40.59V0h2v39.8zM2 300.1a5 5 0 0 1 3.9 3.9H3.83A3 3 0 0 0 0 302.17V256h18v48h-2v-46H2v42.1zM34 241v63h-2v-62H0v-2h34v1zM17 18H0v-2h16V0h2v18h-1zm273-2h14v2h-16V0h2v16zm-32 273v15h-2v-14h-14v14h-2v-16h18v1zM0 92.1A5.02 5.02 0 0 1 6 97a5 5 0 0 1-6 4.9v-2.07a3 3 0 1 0 0-5.66V92.1zM80 272h2v32h-2v-32zm37.9 32h-2.07a3 3 0 0 0-5.66 0h-2.07a5 5 0 0 1 9.8 0zM5.9 0A5.02 5.02 0 0 1 0 5.9V3.83A3 3 0 0 0 3.83 0H5.9zm294.2 0h2.07A3 3 0 0 0 304 3.83V5.9a5 5 0 0 1-3.9-5.9zm3.9 300.1v2.07a3 3 0 0 0-1.83 1.83h-2.07a5 5 0 0 1 3.9-3.9zM97 100a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-48 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 96a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-144a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-96 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm96 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-32 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM49 36a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-32 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM33 68a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 240a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm80-176a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm112 176a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM17 180a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM17 84a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6z'%3E%3C/path%3E%3C/svg%3E&#34;)">You read the whole thing.
Back <a class=underline href=#very-top>to the top</a>?</div></main><footer><div class="h-spaced mb-5 mt-12 text-xs text-verysubtle">All content created by Lukas Knuth and licensed under the
<a class="underline text-bold" href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Attribution-ShareAlike 4.0 International License</a>.
All source code is licensed <a class=underline href=https://opensource.org/license/mit>MIT</a>.
Zu <a class="underline text-bold" href=/impressum>Impressum und Datenschutz</a>, vom deutschen Gesetz vorgeschrieben.</div></footer></body></html>