<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/iAWriterQuattro/iAWriterQuattroS-Bold.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/iAWriterQuattro/iAWriterQuattroS-BoldItalic.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/iAWriterQuattro/iAWriterQuattroS-Italic.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/iAWriterQuattro/iAWriterQuattroS-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>UDP Multicast on Android | Lukas Knuth // Developer</title><link rel=canonical href=https://lknuth.dev/writings/udp_multicast_on_android/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="UDP Multicast on Android"><meta property="og:description" content="About the problems with UDP multicast on the Android mobile OS"><meta property="og:type" content="article"><meta property="og:url" content="https://lknuth.dev/writings/udp_multicast_on_android/"><meta property="article:section" content="writings"><meta property="article:published_time" content="2012-09-04T15:51:15+01:00"><meta property="article:modified_time" content="2012-09-04T15:51:15+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="UDP Multicast on Android"><meta name=twitter:description content="About the problems with UDP multicast on the Android mobile OS"><link rel=stylesheet href=https://lknuth.dev/css/styles.c80037fe069dacf3e7d215521d1844203a2c7d5d6638afbbbd90798790d40182a5712b247ed5969fa7b0440fd20225fee106d6233729d4fc1e4381fd6b36fd14.css integrity="sha512-yAA3/gadrPPn0hVSHRhEIDosfV1mOK+7vZB5h5DUAYKlcSskftWWn6ewRA/SAiX+4QbWIzcp1PweQ4H9azb9FA=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://lknuth.dev/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://lknuth.dev/><div id=logo style=background-image:url(https://lknuth.dev/images/logo.png)></div><div id=title><h1>Lukas Knuth // Developer</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/writings>Writings</a></li><li><a href=/about>About</a></li><li><a href=/imprint>Imprint</a></li></ul></div></header><article class=post itemscope itemtype=http://schema.org/BlogPosting><div class=content itemprop=articleBody><p>I started working on a small inventory system, that keeps track of all the things I buy. To enter new items quickly into the system, I needed a barcode-scanner to scan new articles, transfer them to my computer and allow me to (for example) paste them into a focused input-field.</p><p>I wrote a small Android application, that uses <a href=https://github.com/zxing/zxing>zxing</a> to scan the barcodes and a simple multicasted UDP network connection to broadcast the contents of the code to all listening network devices. This way, I don&rsquo;t need to enter any IP addresses or host-names in the app to reach the listening server application on my computer. The <code>MulticastSocket</code> of the java standard library seemed perfect for this purpose.</p><h2 id=when-android-interferes>When Android interferes</h2><p>After the application was created, I tried it out, just to realize that&mldr; well, nothing happened. After some research on the internet, I found out that Android itself was the source of the problem:</p><blockquote><p>public class <a href=http://developer.android.com/reference/android/net/wifi/WifiManager.MulticastLock.html><strong>WifiManager.MulticastLock</strong></a></p><p><strong>Allows an application to <em>receive</em> Wifi Multicast packets. Normally the Wifi stack filters out packets not explicitly
addressed to this device. Acquring a MulticastLock will cause the stack to receive packets addressed to multicast
addresses.</strong> Processing these extra packets can cause a noticable battery drain and should be disabled when not needed.</p></blockquote><p>Even though the documentation only talks about <em>receiving</em> multicast packages, the same applies for <em>sending</em> them: You need to obtain the <code>MulticastLock</code> in order to work with multicast packages.</p><h3 id=acquiring-a-lock>Acquiring a lock</h3><p>Actually getting the required lock isn&rsquo;t that much trouble at all. Declared the following permissions in your manifest:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#fb4934>&lt;uses-permission</span> <span style=color:#b8bb26;font-weight:700>android:name=</span><span style=color:#b8bb26>&#34;android.permission.CHANGE_WIFI_MULTICAST_STATE&#34;</span> <span style=color:#fb4934>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#fb4934>&lt;uses-permission</span> <span style=color:#b8bb26;font-weight:700>android:name=</span><span style=color:#b8bb26>&#34;android.permission.INTERNET&#34;</span><span style=color:#fb4934>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#fb4934>&lt;uses-permission</span> <span style=color:#b8bb26;font-weight:700>android:name=</span><span style=color:#b8bb26>&#34;android.permission.ACCESS_NETWORK_STATE&#34;</span><span style=color:#fb4934>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#fb4934>&lt;uses-permission</span> <span style=color:#b8bb26;font-weight:700>android:name=</span><span style=color:#b8bb26>&#34;android.permission.ACCESS_WIFI_STATE&#34;</span><span style=color:#fb4934>/&gt;</span>
</span></span></code></pre></div><p>Then use the <code>WifiManager</code> to acquire the lock:</p><div class=highlight><pre tabindex=0 style=color:#ebdbb2;background-color:#282828;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>WifiManager wifi <span style=color:#fe8019>=</span> <span style=color:#fe8019>(</span>WifiManager<span style=color:#fe8019>)</span>getSystemService<span style=color:#fe8019>(</span> Context<span style=color:#fe8019>.</span><span style=color:#b8bb26;font-weight:700>WIFI_SERVICE</span> <span style=color:#fe8019>);</span>
</span></span><span style=display:flex><span><span style=color:#fe8019>if</span><span style=color:#fe8019>(</span>wifi <span style=color:#fe8019>!=</span> <span style=color:#fe8019>null</span><span style=color:#fe8019>){</span>
</span></span><span style=display:flex><span>    WifiManager<span style=color:#fe8019>.</span><span style=color:#b8bb26;font-weight:700>MulticastLock</span> lock <span style=color:#fe8019>=</span> wifi<span style=color:#fe8019>.</span><span style=color:#b8bb26;font-weight:700>createMulticastLock</span><span style=color:#fe8019>(</span><span style=color:#b8bb26>&#34;Log_Tag&#34;</span><span style=color:#fe8019>);</span>
</span></span><span style=display:flex><span>    lock<span style=color:#fe8019>.</span><span style=color:#b8bb26;font-weight:700>acquire</span><span style=color:#fe8019>();</span>
</span></span><span style=display:flex><span><span style=color:#fe8019>}</span>
</span></span></code></pre></div><p>The multicast-lock is <a href=http://developer.android.com/reference/android/net/wifi/WifiManager.MulticastLock.html#acquire%28%29>acquired until</a>:</p><blockquote><p>Locks Wifi Multicast on <strong>until <code>release()</code> is called.</strong>
[&mldr;]
When an <strong>app exits or crashes</strong>, any Multicast locks will [also] be released.</p></blockquote><p>Sending/receiving should work now. Unless&mldr;</p><h2 id=device-problems>Device problems</h2><p>&mldr; you run into the situation where you have a device that just <em>can&rsquo;t do it</em>.</p><p>Reading multiple topics, blog-posts and bug-reports, it turns out that some devices don&rsquo;t (or don&rsquo;t fully) support multicast. Whether they do or don&rsquo;t depends on both the vendor (because they build/optimize the kernel) and the Android version.</p><p>To quote from an <a href="http://code.google.com/p/android/issues/detail?id=2917#c48">Issue regarding Android 1.5 - 2.1</a></p><blockquote><p>I&rsquo;ve spent quite a bit of time debugging mDNS issues with JmDNS on my Evo and HTC Hero (CDMA). What I found is <strong>there
appears to be a filter in place in the broadcom wireless driver on the Evo</strong> (and since I&rsquo;m getting a similar report
from an HTC Desire user - with the same chipset, presumably that handset as well). <strong>The filter, by default, blocks any
non-unicast or network broadcast traffic, including multicast.</strong> Apparently the theory was it&rsquo;s a battery saver.<br><br><strong>The problem appears to be the <code>wpa_supplicant</code> on the Evo does <em>not</em> support removing those filters when you get a
MulticastLock.</strong> (Check the log output right after you get the lock and you&rsquo;ll see what I mean). Unfortunately what
has happened is the hardware vendors have fragmented multicast support&mldr;. :(</p></blockquote><p>It has been reported that switching the <code>/system/bin/wpa_supplicant</code>-binary to a newer version has fixed the issue for those devices, but this comes with two big downsides:</p><ol><li>The phone needs to be rooted</li><li>You can&rsquo;t rely on your users to provide a working environment for your application</li></ol><p>If you&rsquo;re curious, the Issue with the suggested workaround can be found here: <a href="http://code.google.com/p/android/issues/detail?id=8407">Android Issue #8407</a></p><p>Another possible cause might be a problem with the implementation of IGMP on those devices, as suggested in Isaac Taylor&rsquo;s blog-post: <a href=http://www.programmingmobile.com/2012/01/multicast-and-android-big-headache.html>Multicast and Android – A Big Headache</a></p><h3 id=check-if-it-works>Check if it works</h3><p>Well, if it&rsquo;s broken on <em>some</em> devices, there should be a way to tell if it isn&rsquo;t working on the current one, or is there? The answer here is <strong>no</strong>.</p><p>There seems to be no reliable way of telling if multicast works on the current device. Some devices give error-messages in their log-cat output, some simply fail silently (like my HTC Desire HD).</p><p>What makes determining a working environment even harder is, that the problem results from multiple sources. It might be the lower-level network implementation, the kernels network drivers or the IGMP implementation. And there is currently no reliable way of testing for all those cases.</p><p>The same code that fails on my HTC Desire HD (Android 2.3.5) works fine on my Motorola Xoom (Android 4.0.4).</p><h2 id=conclusion>Conclusion</h2><ul><li>Try avoiding multicast in deployed applications for end-users or provide alternatives (direct communication still works fine).</li><li>Acquire the <code>MulticastLock</code> so the system does not ignore the packages send/received</li><li>If you&rsquo;re having problems, check the network-traffic with tools like <a href=http://www.wireshark.org/>WireShark</a> or <a href=http://www.tcpdump.org/>tcpdump</a>.</li></ul></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2023 Lukas Knuth</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/writings>Writings</a></li><li><a href=/about>About</a></li><li><a href=/imprint>Imprint</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script></html>