<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Lukas Knuth"><meta name=description content="I like Low Tech Magazine. Not only is their website solar-powered and only available when the weather is good, they provide an interesting viewpoint on technology as a whole.
Recently, they created a thematic collection of articles called &amp;ldquo;How to Build a Low-tech Internet?&amp;rdquo;. It&amp;rsquo;s sold as a hard-copy book, but not as an EPUB. Since I&amp;rsquo;m almost exclusively reading my books digitally these days - and the articles are all available on their website, I thought I&amp;rsquo;d just create an EPUB myself.
The irony of this is not lost on me."><meta property="og:description" value="I like Low Tech Magazine. Not only is their website solar-powered and only available when the weather is good, they provide an interesting viewpoint on technology as a whole.
Recently, they created a thematic collection of articles called &amp;ldquo;How to Build a Low-tech Internet?&amp;rdquo;. It&amp;rsquo;s sold as a hard-copy book, but not as an EPUB. Since I&amp;rsquo;m almost exclusively reading my books digitally these days - and the articles are all available on their website, I thought I&amp;rsquo;d just create an EPUB myself.
The irony of this is not lost on me."><meta property="og:title" value="Zero to EPUB"><meta property="og:url" value=https://lknuth.dev/writings/zero_to_epub/><meta property="og:type" value=article><meta property="og:article:author" value="Lukas Knuth"><meta property="og:article:published_time" value=2024-05-03T14:00:00+0100><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><title>Zero to EPUB | Lukas Knuth</title>
<link rel="stylesheet" href="/css/main.min.43781f03a3e052bd66bc95d2a302f0d271323dfc7c8a56ec32c60248df0007b3.css" integrity="sha256-Q3gfA6PgUr1mvJXSowLw0nEyPfx8ilbsMsYCSN8AB7M=" crossorigin="anonymous">
<link rel=canonical href=https://lknuth.dev/writings/zero_to_epub/><link rel=icon type=image/png href=https://lknuth.dev/images/favicon-96x96.png sizes=96x96><link rel=icon type=image/svg+xml href=https://lknuth.dev/images/favicon.svg><link rel="shortcut icon" href=https://lknuth.dev/images/favicon.ico><link rel=alternate type=application/rss+xml href=https://lknuth.dev/writings/index.xml title=Writings></head><body id=very-top class="flex flex-col h-screen max-w-6xl container mx-auto bg-pane break-words text-base text-writing md:text-lg antialiased hyphens-auto leading-relaxed font-sans"><header><div class="h-spaced mt-4 md:mt-6 mb-3"><a href=https://lknuth.dev/><div class="w-16 h-16 mr-3 md:mr-5 float-left bg-no-repeat bg-center bg-contain rounded-md" style=background-image:url(https://lknuth.dev/images/favicon.svg)></div><div class="hidden md:!block text-3xl font-bold"><span>Lukas Knuth</span><span class="pl-1 pr-3 tracking-[-0.3em]">//</span><span>Software Engineer</span></div><div class="md:hidden text-xl font-bold truncate text-clip"><span>Lukas Knuth</span><span class="pl-1 pr-2 tracking-[-0.3em]">//</span><span>SWE</span></div></a><nav><ol class="flex text-primary pt-1"><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/writings>Writings</a></li><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/about>About</a></li><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/cv>CV</a></li><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/now>Now</a></li></ol></nav></div></header><main class=grow><article class="h-spaced mt-4 md:mt-6" itemscope itemtype=http://schema.org/BlogPosting><h1 class="text-3xl font-light text-subtle" itemprop="name headline">Zero to EPUB</h1><div class="my-2 text-sm text-subtle"><time datetime="2024-05-03 14:00:00 +0100 +0100" itemprop=datePublished>2024-05-03</time></div><div class=prose itemprop=articleBody><p>I like Low Tech Magazine.
Not only is their website solar-powered and only available when the weather is good, they provide an interesting viewpoint on technology as a whole.</p><p>Recently, they created a thematic collection of articles called <a href=https://solar.lowtechmagazine.com/2023/08/thematic-books-series/ rel=external>&ldquo;How to Build a Low-tech Internet?&rdquo;</a>.
It&rsquo;s sold as a hard-copy book, but not as an EPUB.
Since I&rsquo;m almost exclusively reading my books digitally these days - and the articles are all available on their website, I thought I&rsquo;d just create an EPUB myself.</p><p>The irony of this is not lost on me.</p><h2 id=getting-the-goods><a href=#getting-the-goods>Getting the goods</a></h2><p>On the Low Tech Magazine website, they have a simple Archive page with all articles that they have published.
I simply found all the ones in the book and downloaded them to my local machine.</p><p>I can use <code>wget</code> for this task, the arguments I stole from <a href=https://tinkerlog.dev/journal/downloading-a-webpage-and-all-of-its-assets-with-wget rel=external>Tyler Smith</a>:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>wget -p -k -H -nd -P chapter1 https://cool.site/some-article
</span></span></code></pre></div><p>This does a number of things:</p><ul><li>It downloads the page into the given directory (<code>-P | --directory-prefix</code>)</li><li>Alongside the page, it downloads all styles/images/scripts (<code>-p | --page-requisites</code>)</li><li>All assets are downloaded into a single, flat directory (<code>-nd | --no-directories</code>)</li><li>Even if the assets are from different hosts (<code>-H | --span-hosts</code>)</li><li>Then all links to assets are rewritten to the local path (<code>-k | --convert-links</code>)</li></ul><p>This gives me a new directory with the article in <code>index.html</code>, all images, styles and scripts.
Opening the local index file via the <code>file://</code> protocol (just by double-clicking it) opens it in the browser.
It looks and works as if it was the online version.</p><p>This works fine for this particular website, which is mostly static content.
If you want to download from a website which renders using JavaScript, you&rsquo;ll need to use an actual Browser.
<a href=https://til.simonwillison.net/chrome/headless rel=external>Chrome can get you stated</a>:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>/path/to/chrome  --headless --dump-dom https://www.example.com
</span></span></code></pre></div><p>This will print the rendered websites HTML to stdout.
Downloading the assets that this page links to is left as an exercise for the reader.</p><h2 id=creating-an-epub><a href=#creating-an-epub>Creating an EPUB</a></h2><p>With the content downloaded, I just have to put it into an EPUB.
What little knowledge I had about e-books was that they&rsquo;re basically a Zip file with some HTML content inside.
Surely this can&rsquo;t be too hard.</p><p>I looked at some ready-made tools available on the internet.
Either their output wasn&rsquo;t nice enough, they were too clunky, or they did too much.
It might have just been my own curiosity though.</p><p>I started off by looking at how another great online source for e-books does it: <a href=https://standardebooks.org/ rel=external>StandardEbooks</a>
They take publicly available works, digitized for the public and carefully touch them up to professional standards.
They have a great catalog and a most importantly, a very detailed guide on e-book creation, typesetting and some nice tooling.</p><p>I started by looking through their <em>extensive</em> <a href=https://standardebooks.org/manual/ rel=external>manual of style</a> - and immediately decided this was too detailed.
Their <a href=https://standardebooks.org/contribute/producing-an-ebook-step-by-step rel=external>Step-by-step guide</a> turned out to be a more appropriate resource.
Throughout the guide, they use <a href=https://github.com/standardebooks/tools rel=external>their own tooling</a> to perform various tasks. Which got me thinking.</p><p>Going through the guide, it struck me that there was a bunch of manual work involved.
While I was initially happy to do it <em>once</em> for the one book I really wanted to make, I felt an itch.</p><figure><img src=https://imgs.xkcd.com/comics/automation.png alt="XKCD 1319"><figcaption>I'd rather spend four hours automating a task that takes one hour to do manually.</figcaption></figure><h2 id=automation><a href=#automation>Automation</a></h2><p>So, I want to automatically bundle a bunch of static HTML into an EPUB container.
I will need to:</p><ol><li>EPUBs use XHTML, so I will have to convert the downloaded HTML to valid XHTML</li><li>I only want the actual article portion of the page, so I have to extract that part</li><li>Cleanup the XHTML and remove unnecessary elements and properties (like styling) left over from the website</li><li>Bundle and link all the Images used in the articles</li><li>Generate the required EPUB scaffolding like the manifest, table of contents, etc</li></ol><p>Let&rsquo;s get started.</p><h3 id=wrangling-html><a href=#wrangling-html>Wrangling HTML</a></h3><p>You <a href=https://stackoverflow.com/a/1732454/717341 rel=external>wouldn&rsquo;t parse HTML with Regex</a>, so what else is there?
Because I had just installed the Standard e-books tools, which are written in Python, I read into <a href=https://beautiful-soup-4.readthedocs.io/en/latest/ rel=external>BeautifulSoup</a>.
This library can parse an entire DOM from an HTML source and offers navigation and manipulation functions.</p><p>My first attempt at a script to clean up and convert my HTML to XHTML looks like this:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#179299>import</span> <span style=color:#fe640b>sys</span>
</span></span><span style=display:flex><span><span style=color:#179299>from</span> <span style=color:#fe640b>bs4</span> <span style=color:#179299>import</span> BeautifulSoup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8839ef>def</span> <span style=color:#1e66f5>cleanup</span>(tag):
</span></span><span style=display:flex><span>  <span style=color:#8839ef>for</span> noise <span style=color:#04a5e5;font-weight:700>in</span> tag<span style=color:#04a5e5;font-weight:700>.</span>find_all([<span style=color:#40a02b>&#34;div&#34;</span>, <span style=color:#40a02b>&#34;section&#34;</span>, <span style=color:#40a02b>&#34;header&#34;</span>]):
</span></span><span style=display:flex><span>    noise<span style=color:#04a5e5;font-weight:700>.</span>unwrap()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8839ef>with</span> <span style=color:#04a5e5>open</span>(sys<span style=color:#04a5e5;font-weight:700>.</span>argv[<span style=color:#fe640b>1</span>]) <span style=color:#8839ef>as</span> source:
</span></span><span style=display:flex><span>  soup <span style=color:#04a5e5;font-weight:700>=</span> BeautifulSoup(source, <span style=color:#40a02b>&#34;html.parser&#34;</span>)
</span></span><span style=display:flex><span>  article <span style=color:#04a5e5;font-weight:700>=</span> soup<span style=color:#04a5e5;font-weight:700>.</span>find(<span style=color:#40a02b>&#34;section&#34;</span>, <span style=color:#04a5e5>id</span><span style=color:#04a5e5;font-weight:700>=</span><span style=color:#40a02b>&#34;content&#34;</span>)
</span></span><span style=display:flex><span>  cleanup(article)
</span></span><span style=display:flex><span>  <span style=color:#8839ef>with</span> <span style=color:#04a5e5>open</span>(<span style=color:#40a02b>&#34;out.xhtml&#34;</span>, <span style=color:#40a02b>&#34;w&#34;</span>) <span style=color:#8839ef>as</span> dest:
</span></span><span style=display:flex><span>    dest<span style=color:#04a5e5;font-weight:700>.</span>write(<span style=color:#04a5e5>str</span>(article))
</span></span></code></pre></div><p>I looked into the HTML files of the articles I had downloaded and found that the content was in a single <code>&lt;section></code> tag.
Next I looked for any elements that were needed on the website only and unwrapped them, removing the element and it&rsquo;s properties but retaining its inner tags.
Lastly, converting the DOM to a string gives valid XHTML by default, so just write that out.</p><p>This approach has problems.
For starters, the code is too specific to the HTML structure of the articles from Low Tech Magazine.
It assumes too much about it&rsquo;s input to be useful elsewhere.</p><p>The second issue is that now, with elements like <code>&lt;header></code> unwrapped, the title and author are just part of the article body.
This makes it hard to present them clearly.
It also makes it hard to automatically generate a table of contents from the articles without making the code <em>even more</em> specific to the structure.</p><h3 id=learn-to-stop-worrying><a href=#learn-to-stop-worrying>Learn to stop worrying</a></h3><p>By chance when looking into how other tools automate this part, I came across <a href=https://github.com/mozilla/readability rel=external>mozilla/readability</a>.
This is the standalone library powering the FireFox &ldquo;Reader View&rdquo; feature.
It simplifies page content and presents it very much like an e-book reader would.</p><p>Eureka!
I can harness this power for myself.
It&rsquo;s pretty simple too:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8839ef>const</span> { JSDOM } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#34;jsdom&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> { Readability } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#34;@mozilla/readability&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> fs <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#34;fs&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d20f39>function</span> simplify(html) {
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> doc <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> JSDOM(html)
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> reader <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> Readability(doc.<span style=color:#04a5e5>window</span>.<span style=color:#04a5e5>document</span>)
</span></span><span style=display:flex><span>  <span style=color:#8839ef>return</span> reader.parse()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> file <span style=color:#04a5e5;font-weight:700>=</span> fs.readFileSync(process.argv[<span style=color:#fe640b>2</span>], <span style=color:#40a02b>&#34;utf8&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> simple <span style=color:#04a5e5;font-weight:700>=</span> simplify(file)
</span></span><span style=display:flex><span>fs.writeFileSync(<span style=color:#40a02b>&#34;out.xhtml&#34;</span>, simple.content, <span style=color:#40a02b>&#34;utf8&#34;</span>)
</span></span></code></pre></div><p>Since &ldquo;readability&rdquo; is a JavaScript library, I switched over from Python.
The above code parses the entire HTML file, finds the relevant article text and simplifies it greatly.</p><p>&ldquo;readability&rdquo; also parses a bunch of metadata from the article, such as title, author publishing time, etc.
I <em>could</em> simply render this information into a <code>&lt;header></code> for the article.
But this is also exactly what I need to build a table of contents later on.</p><p>Crucially, the result still has many <code>&lt;div></code> and <code>&lt;span></code> tags used for styling.
In my pursuit of clean, simple XHTML, I will still have to find and unwrap these tags.
And while this was easy enough with BeautifulSoup, JSDom doesn&rsquo;t surface a nice and simple API.
I thought about using jQuery on top of JSDom to make the API nicer, but decided this was madness.</p><h3 id=perspective-shift><a href=#perspective-shift>Perspective shift</a></h3><p>What I need is a simpler intermediate format.
One that doesn&rsquo;t allow for complicated markup and focuses on purely textual content.
That allows me to store the extracted metadata along with the content, in a structured form.
And that can easily be converted to XHTML again.</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-markdown data-lang=markdown><span style=display:flex><span>---
</span></span><span style=display:flex><span>title: Test
</span></span><span style=display:flex><span>author: Me
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#fe640b;font-weight:700># Obviously
</span></span></span><span style=display:flex><span><span style=color:#fe640b;font-weight:700></span>
</span></span><span style=display:flex><span>Markdown is my intermediate format! With YAML front-matter to store metadata.
</span></span></code></pre></div><p>The aptly named <a href=https://github.com/mixmark-io/turndown rel=external>turndown</a> library does exactly that: Turn HTML to Markdown.
It does not support the YAML front-matter out-of-the-box, but that&rsquo;s easy enough to add.</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8839ef>const</span> TurndownService <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#34;turndown&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d20f39>function</span> generateMarkdown(readable) {
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> td <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> TurndownService()
</span></span><span style=display:flex><span>  td.keep([<span style=color:#40a02b>&#34;table&#34;</span>])
</span></span><span style=display:flex><span>  <span style=color:#8839ef>return</span> td.turndown(readable.content)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d20f39>function</span> generateFrontMatter(readable) {
</span></span><span style=display:flex><span>	<span style=color:#9ca0b0;font-style:italic>// NOTE: Can&#39;t correctly indent this because then front-matter in the file is indented and breaks YAML
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic></span>	<span style=color:#8839ef>return</span> <span style=color:#40a02b>`---
</span></span></span><span style=display:flex><span><span style=color:#40a02b>title: </span><span style=color:#40a02b>${</span>readable.title<span style=color:#40a02b>}</span><span style=color:#40a02b>
</span></span></span><span style=display:flex><span><span style=color:#40a02b>author: </span><span style=color:#40a02b>${</span>readable.byline<span style=color:#40a02b>}</span><span style=color:#40a02b>
</span></span></span><span style=display:flex><span><span style=color:#40a02b>---
</span></span></span><span style=display:flex><span><span style=color:#40a02b>
</span></span></span><span style=display:flex><span><span style=color:#40a02b>`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic>// In addition to the above script
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> output <span style=color:#04a5e5;font-weight:700>=</span> generateFrontMatter(simple) <span style=color:#04a5e5;font-weight:700>+</span> generateMarkdown(simple)
</span></span><span style=display:flex><span>fs.writeFileSync(<span style=color:#40a02b>&#34;out.md&#34;</span>, output, <span style=color:#40a02b>&#34;utf8&#34;</span>)
</span></span></code></pre></div><p>This gives good results.
Now I have a simpler format that still retains the actual content of the article.
As an added bonus, it&rsquo;s much easier to make manual changes to a markdown file.</p><p>You can find the <a href=https://github.com/LukasKnuth/epub_tools/blob/main/simplify.js rel=external>full script</a> in the repo that accompanies this post.</p><h2 id=bundle-to-epub><a href=#bundle-to-epub>Bundle to EPUB</a></h2><p>With the actual content now cleaned up, it is time to bundle everything together.</p><p>Rather than read through the EPUB standard, I looked for a minimal working example instead.
I found <a href=https://github.com/thansen0/sample-epub-minimal rel=external>Minimal E-Book</a>, which is exactly that.
Let&rsquo;s get the simple stuff out of the way first:</p><ul><li>A <code>.epub</code> file is a renamed ZIP file</li><li>In the root of that ZIP file, the <code>mimetype</code> file is located with <code>application/epub+zip</code> as it&rsquo;s content</li><li>Also in the root, the standard expects a <code>META-INF</code> folder with a <a href=https://github.com/thansen0/sample-epub-minimal/blob/master/minimal/META-INF/container.xml rel=external>single <code>container.xml</code> file</a></li><li>That file simply points to the <code>content.opf</code> file, which can exist in an arbitrary directory</li><li>The <code>content.opf</code> file is a manifest of all files the e-book references</li></ul><p>With this information, let&rsquo;s build a simple bundler.
It receives markdown files as arguments, renders them to XHTML and adds them to the manifest.</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#8839ef>const</span> { marked } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#34;marked&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> { markedXhtml } <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#34;marked-xhtml&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> frontMatter <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#34;yaml-front-matter&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> Handlebars <span style=color:#04a5e5;font-weight:700>=</span> require(<span style=color:#40a02b>&#34;handlebars&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>marked.use(markedXhtml())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> articleTemplate <span style=color:#04a5e5;font-weight:700>=</span> Handlebars.compile(fs.readFileSync(<span style=color:#40a02b>&#34;templates/article.xhtml&#34;</span>).toString())
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> manifestTemplate <span style=color:#04a5e5;font-weight:700>=</span> Handlebars.compile(fs.readFileSync(<span style=color:#40a02b>&#34;templates/content.opf&#34;</span>).toString())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d20f39>function</span> parseArticle(file) {
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> content <span style=color:#04a5e5;font-weight:700>=</span> fs.readFileSync(file, <span style=color:#40a02b>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> matter <span style=color:#04a5e5;font-weight:700>=</span> frontMatter.safeLoadFront(content)
</span></span><span style=display:flex><span>  matter.id <span style=color:#04a5e5;font-weight:700>=</span> path.parse(file).name <span style=color:#9ca0b0;font-style:italic>// file-name without the extension
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#8839ef>return</span> matter
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#d20f39>function</span> writeArticle(article) {
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> content <span style=color:#04a5e5;font-weight:700>=</span> marked.parse(article.__content)
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> rendered <span style=color:#04a5e5;font-weight:700>=</span> articleTemplate({...article, content})
</span></span><span style=display:flex><span>  <span style=color:#9ca0b0;font-style:italic>// TODO write the file to our ZIP file
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#8839ef>return</span> {file<span style=color:#04a5e5;font-weight:700>:</span> article.id<span style=color:#04a5e5;font-weight:700>+</span><span style=color:#40a02b>&#34;.xhtml&#34;</span>, id<span style=color:#04a5e5;font-weight:700>:</span> article.id, mimetype<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;application/xhtml+xml&#34;</span>}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> files <span style=color:#04a5e5;font-weight:700>=</span> process.argv.split(<span style=color:#fe640b>2</span>).map(parseArticle).map(writeArticle)
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> manifest <span style=color:#04a5e5;font-weight:700>=</span> manifestTemplate({files})
</span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic>// TODO write manifest to ZIP file
</span></span></span></code></pre></div><p>The snippet omits writing the actual files to the file system/ZIP file for brevity.
The <a href=https://github.com/LukasKnuth/epub_tools/blob/main/templates/article.xhtml rel=external>article template</a> is less interesting, lets look at the manifest instead:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8839ef>&lt;package</span> <span style=color:#1e66f5>xmlns=</span><span style=color:#40a02b>&#34;http://www.idpf.org/2007/opf&#34;</span> <span style=color:#1e66f5>version=</span><span style=color:#40a02b>&#34;3.0&#34;</span><span style=color:#8839ef>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#9ca0b0;font-style:italic>&lt;!-- Metadata element removed --&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#8839ef>&lt;manifest&gt;</span>
</span></span><span style=display:flex><span>	  {{#each files}}
</span></span><span style=display:flex><span>	  <span style=color:#8839ef>&lt;item</span> <span style=color:#1e66f5>id=</span><span style=color:#40a02b>&#34;{{id}}&#34;</span> <span style=color:#1e66f5>href=</span><span style=color:#40a02b>&#34;{{file}}&#34;</span> <span style=color:#1e66f5>media-type=</span><span style=color:#40a02b>&#34;{{mimetype}}&#34;</span> <span style=color:#8839ef>/&gt;</span>
</span></span><span style=display:flex><span>	  {{/each}}
</span></span><span style=display:flex><span>	<span style=color:#8839ef>&lt;/manifest&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#8839ef>&lt;spine&gt;</span>
</span></span><span style=display:flex><span>	  {{#each files}}
</span></span><span style=display:flex><span>	  <span style=color:#8839ef>&lt;itemref</span> <span style=color:#1e66f5>idref=</span><span style=color:#40a02b>&#34;{{id}}&#34;</span> <span style=color:#8839ef>/&gt;</span>
</span></span><span style=display:flex><span>	  {{/each}}
</span></span><span style=display:flex><span>	<span style=color:#8839ef>&lt;/spine&gt;</span>
</span></span><span style=display:flex><span><span style=color:#8839ef>&lt;/package&gt;</span>
</span></span></code></pre></div><p><strong>NOTE</strong>: This snippet is shortened - and therefore <strong>not fully valid</strong>.</p><p>The main elements are:</p><ul><li><code>&lt;metadata></code> (we&rsquo;ll look at that later)</li><li><code>&lt;manifest></code> lists <em>all</em> files in the EPUB</li><li><code>&lt;spine></code> sets the order in which Text files are stitched together into a book</li></ul><p>If I Zip all of this up together, the structure should look like this:</p><pre tabindex=0><code>out.epub
├── META-INF
│  └── container.xml
├── mimetype
└── OEBPS
   ├── c1-internet-speed-limit.xhtml
   ├── c2-18th-century-email.xhtml
   └── content.opf
</code></pre><p>This is a valid EPUB!
A boring one though.</p><h3 id=styles><a href=#styles>Styles</a></h3><p>Since EPUB builds on web technologies, it makes sense that styling is done in CSS.
It also makes sense that the support varies a lot from vendor to vendor.
Some styles are accepted by <em>some</em> readers but ignored by others.</p><p>To make it easy on myself, I reused this <a href=http://bbebooksthailand.com/bb-CSS-boilerplate.html rel=external>CSS Boilerplate</a> and simplified it.
I did add some extra rules for chapter headings, though.
The full style is <a href=https://github.com/LukasKnuth/epub_tools/blob/main/templates/style.css rel=external>in the repo</a> if you&rsquo;re interested.</p><p>As this is yet another file, it also requires an entry in the <code>&lt;manifest></code> of our <code>content.opf</code> file.
The entry has the same format, except the mimetype is <code>text/css</code>.
I can then link it in the XHTML files using the normal <code>&lt;link href="css/style.css" rel="stylesheet" type="text/css"/></code> tag.
Note that the <code>href</code> is relative to the <code>content.opf</code> file, so no traversal via <code>../</code> is required.</p><h3 id=images><a href=#images>Images</a></h3><p>This is the more interesting problem: Images from the articles are downloaded together with the text, so the final EPUB should also have these images.
In practice this means I have to:</p><ol><li>Find all the images referenced in an article</li><li>Find the local image (if it exists)</li><li>Add the image to the ZIP file and <code>&lt;manifest></code></li><li>Rewrite the reference in the article to match the path inside the EPUB</li></ol><p>Luckily, the &ldquo;marked&rdquo; Markdown library I&rsquo;m using allows invoking the lexer directly, which gives us the <a href=https://en.wikipedia.org/wiki/Abstract_syntax_tree rel=external>AST</a> for the parsed markdown file.
To explain what that means and why it helps, lets look at an example:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#04a5e5;font-weight:700>&gt;</span> marked.lexer(<span style=color:#40a02b>&#34;![the alt text](path/to/img.png)&#34;</span>)
</span></span><span style=display:flex><span>[
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;paragraph&#39;</span>,
</span></span><span style=display:flex><span>    raw<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;![the alt text](path/to/img.png)&#39;</span>,
</span></span><span style=display:flex><span>    text<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;![the alt text](path/to/img.png)&#39;</span>,
</span></span><span style=display:flex><span>    tokens<span style=color:#04a5e5;font-weight:700>:</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        type<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;image&#39;</span>,
</span></span><span style=display:flex><span>        raw<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;![the alt text](path/to/img.png)&#39;</span>,
</span></span><span style=display:flex><span>        href<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;path/to/img.png&#39;</span>,
</span></span><span style=display:flex><span>        title<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#fe640b>null</span>,
</span></span><span style=display:flex><span>        text<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#39;the alt text&#39;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  links<span style=color:#04a5e5;font-weight:700>:</span> {}
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>For the given Markdown text, the lexer parses the syntax into a (very small) tree.
The first node in the tree is the <code>paragraph</code>, which wraps all markdown blocks.
Next, we have the <code>image</code> with the <code>href</code> pointing to the image file.
This is what I&rsquo;m interested in.</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#d20f39>function</span> writeImages(tokens, article_id, zip, results) {
</span></span><span style=display:flex><span>  <span style=color:#8839ef>for</span> (<span style=color:#8839ef>const</span> token <span style=color:#8839ef>of</span> tokens) {
</span></span><span style=display:flex><span>    <span style=color:#8839ef>if</span> (token.type <span style=color:#04a5e5;font-weight:700>===</span> <span style=color:#40a02b>&#34;image&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#8839ef>if</span> (fs.existsSync(token.href)) {
</span></span><span style=display:flex><span>        <span style=color:#8839ef>const</span> zip_path <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#40a02b>`img/</span><span style=color:#40a02b>${</span>article_id<span style=color:#40a02b>}</span><span style=color:#40a02b>/</span><span style=color:#40a02b>${</span>path.basename(token.href)<span style=color:#40a02b>}</span><span style=color:#40a02b>`</span>
</span></span><span style=display:flex><span>        <span style=color:#9ca0b0;font-style:italic>// add to Zip
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic></span>        zip.file(zip_path, fs.createReadStream(token.href))
</span></span><span style=display:flex><span>        <span style=color:#9ca0b0;font-style:italic>// Rewrite href
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic></span>        token.href <span style=color:#04a5e5;font-weight:700>=</span> zip_path
</span></span><span style=display:flex><span>        <span style=color:#9ca0b0;font-style:italic>// add to manifest
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic></span>        results.push({file<span style=color:#04a5e5;font-weight:700>:</span> zip_path, id<span style=color:#04a5e5;font-weight:700>:</span> zip_path, mimetype<span style=color:#04a5e5;font-weight:700>:</span> mime.lookup(token.href)})
</span></span><span style=display:flex><span>      } <span style=color:#8839ef>else</span> {
</span></span><span style=display:flex><span>        console.warn(<span style=color:#40a02b>`Image </span><span style=color:#40a02b>${</span>full_path<span style=color:#40a02b>}</span><span style=color:#40a02b> not found. Ignoring...`</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#8839ef>else</span> {
</span></span><span style=display:flex><span>      writeImages(token.tokens, article_id, zip, results)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#8839ef>return</span> results
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This simple recursive function traverses the AST, looking for any <code>image</code> nodes.
Once it completes, all referenced image files are in the ZIP and the <code>href</code> are updated to reflect the path inside the EPUB.
Doing this while bundling the e-book has the benefit that it does not matter where the images are stored on disk, as long as the references to the image files are valid.</p><p>The array I return has the same objects as the <code>writeArticle</code> from earlier.
I can update the function to return an array instead of a single object and add both article and its images to the manifest:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#d20f39>function</span> writeArticle(article) {
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> tokens <span style=color:#04a5e5;font-weight:700>=</span> marked.lexer(article.__content)
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> images <span style=color:#04a5e5;font-weight:700>=</span> writeImages(tokens, article.id, zip, [])
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> content <span style=color:#04a5e5;font-weight:700>=</span> marked.parser(tokens)
</span></span><span style=display:flex><span>  <span style=color:#9ca0b0;font-style:italic>// ... code as before
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic></span>  <span style=color:#8839ef>return</span> [
</span></span><span style=display:flex><span>    {file<span style=color:#04a5e5;font-weight:700>:</span> article.id<span style=color:#04a5e5;font-weight:700>+</span><span style=color:#40a02b>&#34;.xhtml&#34;</span>, id<span style=color:#04a5e5;font-weight:700>:</span> article.id, title<span style=color:#04a5e5;font-weight:700>:</span> article.title, mimetype<span style=color:#04a5e5;font-weight:700>:</span> <span style=color:#40a02b>&#34;application/xhtml+xml&#34;</span>},
</span></span><span style=display:flex><span>    ...images
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic>// Replace map() with flatMap()
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic></span><span style=color:#8839ef>const</span> files <span style=color:#04a5e5;font-weight:700>=</span> process.argv.split(<span style=color:#fe640b>2</span>).map(parseArticle).flatMap(writeArticle)
</span></span><span style=display:flex><span><span style=color:#8839ef>const</span> manifest <span style=color:#04a5e5;font-weight:700>=</span> manifestTemplate({files})
</span></span></code></pre></div><p>With this in place, I now have all files in the ZIP and listed in the manifest.
Almost done!</p><h3 id=table-of-contents><a href=#table-of-contents>Table of Contents</a></h3><p>I lied to you.
In the snippet above, I snuck in an additional change.
I added <code>title</code> to the object describing the article.</p><p>I have this information from the metadata the &ldquo;readability&rdquo; library parsed out.
It&rsquo;s time to use it now to create the Table of Contents.</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#d20f39>function</span> writeManifest(zip, files) {
</span></span><span style=display:flex><span>  <span style=color:#8839ef>const</span> toc <span style=color:#04a5e5;font-weight:700>=</span> files.filter(f =&gt; <span style=color:#04a5e5;font-weight:700>!!</span>f.title)
</span></span><span style=display:flex><span>  zip.file(<span style=color:#40a02b>&#34;toc.xhtml&#34;</span>, tocTemplate({toc}))
</span></span><span style=display:flex><span>  zip.file(<span style=color:#40a02b>&#34;content.opf&#34;</span>, manifestTemplate({files, toc}))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I use the <code>title</code> property to filter out everything that should show up in our table of contents.
The actual table is created using the <code>toc.xhtml</code> file, which is <a href=https://github.com/LukasKnuth/epub_tools/blob/main/templates/toc.xhtml rel=external>pretty boring</a> again (it&rsquo;s just an <code>&lt;ol></code>).
More importantly, I have to update <code>content.opf</code> with this new information:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8839ef>&lt;package</span> <span style=color:#1e66f5>xmlns=</span><span style=color:#40a02b>&#34;http://www.idpf.org/2007/opf&#34;</span> <span style=color:#1e66f5>version=</span><span style=color:#40a02b>&#34;3.0&#34;</span><span style=color:#8839ef>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#9ca0b0;font-style:italic>&lt;!-- Metadata element removed --&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#8839ef>&lt;manifest&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>&lt;item</span> <span style=color:#1e66f5>id=</span><span style=color:#40a02b>&#34;toc&#34;</span> <span style=color:#1e66f5>href=</span><span style=color:#40a02b>&#34;toc.xhtml&#34;</span> <span style=color:#1e66f5>media-type=</span><span style=color:#40a02b>&#34;application/xhtml+xml&#34;</span> <span style=color:#1e66f5>properties=</span><span style=color:#40a02b>&#34;nav&#34;</span> <span style=color:#8839ef>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>&lt;item</span> <span style=color:#1e66f5>id=</span><span style=color:#40a02b>&#34;style&#34;</span> <span style=color:#1e66f5>href=</span><span style=color:#40a02b>&#34;css/style.css&#34;</span> <span style=color:#1e66f5>media-type=</span><span style=color:#40a02b>&#34;text/css&#34;</span> <span style=color:#8839ef>/&gt;</span>
</span></span><span style=display:flex><span>    {{#each files}}
</span></span><span style=display:flex><span>    <span style=color:#8839ef>&lt;item</span> <span style=color:#1e66f5>id=</span><span style=color:#40a02b>&#34;{{id}}&#34;</span> <span style=color:#1e66f5>href=</span><span style=color:#40a02b>&#34;{{file}}&#34;</span> <span style=color:#1e66f5>media-type=</span><span style=color:#40a02b>&#34;{{mimetype}}&#34;</span> <span style=color:#8839ef>/&gt;</span>
</span></span><span style=display:flex><span>    {{/each}}
</span></span><span style=display:flex><span>  <span style=color:#8839ef>&lt;/manifest&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#8839ef>&lt;spine&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>&lt;itemref</span> <span style=color:#1e66f5>idref=</span><span style=color:#40a02b>&#34;toc&#34;</span> <span style=color:#8839ef>/&gt;</span>
</span></span><span style=display:flex><span>    {{#each toc}}
</span></span><span style=display:flex><span>    <span style=color:#8839ef>&lt;itemref</span> <span style=color:#1e66f5>idref=</span><span style=color:#40a02b>&#34;{{id}}&#34;</span> <span style=color:#8839ef>/&gt;</span>
</span></span><span style=display:flex><span>    {{/each}}
</span></span><span style=display:flex><span>  <span style=color:#8839ef>&lt;/spine&gt;</span>
</span></span><span style=display:flex><span><span style=color:#8839ef>&lt;/package&gt;</span>
</span></span></code></pre></div><p>I updated <code>&lt;spine></code> to only include the table of content files.
If I didn&rsquo;t do that, the CSS file and all our images are in the <code>&lt;spine></code> as well.
Note that the <code>toc.xhtml</code> entries are static, because they&rsquo;ll always be there.</p><p>Now there is an automatically generated Table of Contents from our actual article titles.
Everything is coming together nicely.</p><h3 id=metadata><a href=#metadata>Metadata</a></h3><p>Last stop: metadata.
I have held onto this bit for last because it&rsquo;s more involved than is apparent.
Here is the <code>content.opf</code> file again, this time only the <code>&lt;metadata></code> part:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#8839ef>&lt;package</span> <span style=color:#1e66f5>xmlns=</span><span style=color:#40a02b>&#34;http://www.idpf.org/2007/opf&#34;</span> <span style=color:#1e66f5>unique-identifier=</span><span style=color:#40a02b>&#34;uid&#34;</span> <span style=color:#1e66f5>version=</span><span style=color:#40a02b>&#34;3.0&#34;</span><span style=color:#8839ef>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#8839ef>&lt;metadata</span> <span style=color:#1e66f5>xmlns:dc=</span><span style=color:#40a02b>&#34;http://purl.org/dc/elements/1.1/&#34;</span><span style=color:#8839ef>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>&lt;dc:identifier</span> <span style=color:#1e66f5>id=</span><span style=color:#40a02b>&#34;uid&#34;</span><span style=color:#8839ef>&gt;</span>urn:uuid:{{uuid}}<span style=color:#8839ef>&lt;/dc:identifier&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>&lt;dc:title</span> <span style=color:#1e66f5>id=</span><span style=color:#40a02b>&#34;t1&#34;</span><span style=color:#8839ef>&gt;</span>{{title}}<span style=color:#8839ef>&lt;/dc:title&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>&lt;dc:creator</span> <span style=color:#1e66f5>id=</span><span style=color:#40a02b>&#34;author&#34;</span><span style=color:#8839ef>&gt;</span>{{author}}<span style=color:#8839ef>&lt;/dc:creator&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>&lt;dc:language&gt;</span>en<span style=color:#8839ef>&lt;/dc:language&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#8839ef>&lt;/metadata&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#9ca0b0;font-style:italic>&lt;!-- manifest/spine come here --&gt;</span>
</span></span><span style=display:flex><span><span style=color:#8839ef>&lt;/package&gt;</span>
</span></span></code></pre></div><p>The <a href=https://www.w3.org/TR/epub-33/#sec-opf-dcmes-required rel=external>EPUB 3.3 specification</a> defines the required meta elements are <code>dc:identifier</code>, <code>dc:title</code> and <code>dc:language</code>.</p><p>While title and language are pretty clear, the identifier is supposed to identify this particular book uniquely.
It is referenced in the <code>&lt;package></code> element, where <code>unique-identifier</code> points to the ID we gave to the <code>dc:identifier</code> element.
Because my bootleg book doesn&rsquo;t have an official ISBN, I use <code>urn:uuid</code> and generate a new UUID each time its bundled.
Note that the spec says:</p><blockquote><p>Unique Identifiers should have maximal persistence both for referencing and distribution purposes. EPUB creators should not issue new identifiers when making minor revisions such as updating metadata, fixing errata, or making similar minor changes.</p></blockquote><p>So if you&rsquo;re going to publish the EPUB, the identifier should be more stable than this.
For my purposes, where I&rsquo;m just building them for myself, it&rsquo;s fine though.</p><p>To verify the book - including the metadata - I use <a href=https://www.w3.org/publishing/epubcheck/ rel=external>EPUBCheck</a>.
You can freely download it and let it run over the whole <code>.epub</code> file.
It was helpful to point me to articles that required additional manual touch up.</p><h2 id=wrap-up><a href=#wrap-up>Wrap up</a></h2><p>That&rsquo;s it.
Did I have to make it this complicated for myself? Probably not.
It was a rewarding little programming exercise that I could work through without major hurdles and just build out.
It was fun.
And now I have a new book to read.</p><p>The snippets in this article are taken from the accompanying <a href=https://github.com/LukasKnuth/epub_tools/ rel=external>repository</a>, which has the full scripts, template and docs.</p></div></article><div class="mt-8 mb-3 py-4 px-5 md:px-9" style="background-image:url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 304 304' width='304' height='304'%3E%3Cpath fill='%23c8c8c8' fill-opacity='0.5' d='M44.1 224a5 5 0 1 1 0 2H0v-2h44.1zm160 48a5 5 0 1 1 0 2H82v-2h122.1zm57.8-46a5 5 0 1 1 0-2H304v2h-42.1zm0 16a5 5 0 1 1 0-2H304v2h-42.1zm6.2-114a5 5 0 1 1 0 2h-86.2a5 5 0 1 1 0-2h86.2zm-256-48a5 5 0 1 1 0 2H0v-2h12.1zm185.8 34a5 5 0 1 1 0-2h86.2a5 5 0 1 1 0 2h-86.2zM258 12.1a5 5 0 1 1-2 0V0h2v12.1zm-64 208a5 5 0 1 1-2 0v-54.2a5 5 0 1 1 2 0v54.2zm48-198.2V80h62v2h-64V21.9a5 5 0 1 1 2 0zm16 16V64h46v2h-48V37.9a5 5 0 1 1 2 0zm-128 96V208h16v12.1a5 5 0 1 1-2 0V210h-16v-76.1a5 5 0 1 1 2 0zm-5.9-21.9a5 5 0 1 1 0 2H114v48H85.9a5 5 0 1 1 0-2H112v-48h12.1zm-6.2 130a5 5 0 1 1 0-2H176v-74.1a5 5 0 1 1 2 0V242h-60.1zm-16-64a5 5 0 1 1 0-2H114v48h10.1a5 5 0 1 1 0 2H112v-48h-10.1zM66 284.1a5 5 0 1 1-2 0V274H50v30h-2v-32h18v12.1zM236.1 176a5 5 0 1 1 0 2H226v94h48v32h-2v-30h-48v-98h12.1zm25.8-30a5 5 0 1 1 0-2H274v44.1a5 5 0 1 1-2 0V146h-10.1zm-64 96a5 5 0 1 1 0-2H208v-80h16v-14h-42.1a5 5 0 1 1 0-2H226v18h-16v80h-12.1zm86.2-210a5 5 0 1 1 0 2H272V0h2v32h10.1zM98 101.9V146H53.9a5 5 0 1 1 0-2H96v-42.1a5 5 0 1 1 2 0zM53.9 34a5 5 0 1 1 0-2H80V0h2v34H53.9zm60.1 3.9V66H82v64H69.9a5 5 0 1 1 0-2H80V64h32V37.9a5 5 0 1 1 2 0zM101.9 82a5 5 0 1 1 0-2H128V37.9a5 5 0 1 1 2 0V82h-28.1zm16-64a5 5 0 1 1 0-2H146v44.1a5 5 0 1 1-2 0V18h-26.1zm102.2 270a5 5 0 1 1 0 2H98v14h-2v-16h124.1zM242 149.9V160h16v34h-16v62h48v48h-2v-46h-48v-66h16v-30h-16v-12.1a5 5 0 1 1 2 0zM53.9 18a5 5 0 1 1 0-2H64V2H48V0h18v18H53.9zm112 32a5 5 0 1 1 0-2H192V0h50v2h-48v48h-28.1zm-48-48a5 5 0 0 1-9.8-2h2.07a3 3 0 1 0 5.66 0H178v34h-18V21.9a5 5 0 1 1 2 0V32h14V2h-58.1zm0 96a5 5 0 1 1 0-2H137l32-32h39V21.9a5 5 0 1 1 2 0V66h-40.17l-32 32H117.9zm28.1 90.1a5 5 0 1 1-2 0v-76.51L175.59 80H224V21.9a5 5 0 1 1 2 0V82h-49.59L146 112.41v75.69zm16 32a5 5 0 1 1-2 0v-99.51L184.59 96H300.1a5 5 0 0 1 3.9-3.9v2.07a3 3 0 0 0 0 5.66v2.07a5 5 0 0 1-3.9-3.9H185.41L162 121.41v98.69zm-144-64a5 5 0 1 1-2 0v-3.51l48-48V48h32V0h2v50H66v55.41l-48 48v2.69zM50 53.9v43.51l-48 48V208h26.1a5 5 0 1 1 0 2H0v-65.41l48-48V53.9a5 5 0 1 1 2 0zm-16 16V89.41l-34 34v-2.82l32-32V69.9a5 5 0 1 1 2 0zM12.1 32a5 5 0 1 1 0 2H9.41L0 43.41V40.6L8.59 32h3.51zm265.8 18a5 5 0 1 1 0-2h18.69l7.41-7.41v2.82L297.41 50H277.9zm-16 160a5 5 0 1 1 0-2H288v-71.41l16-16v2.82l-14 14V210h-28.1zm-208 32a5 5 0 1 1 0-2H64v-22.59L40.59 194H21.9a5 5 0 1 1 0-2H41.41L66 216.59V242H53.9zm150.2 14a5 5 0 1 1 0 2H96v-56.6L56.6 162H37.9a5 5 0 1 1 0-2h19.5L98 200.6V256h106.1zm-150.2 2a5 5 0 1 1 0-2H80v-46.59L48.59 178H21.9a5 5 0 1 1 0-2H49.41L82 208.59V258H53.9zM34 39.8v1.61L9.41 66H0v-2h8.59L32 40.59V0h2v39.8zM2 300.1a5 5 0 0 1 3.9 3.9H3.83A3 3 0 0 0 0 302.17V256h18v48h-2v-46H2v42.1zM34 241v63h-2v-62H0v-2h34v1zM17 18H0v-2h16V0h2v18h-1zm273-2h14v2h-16V0h2v16zm-32 273v15h-2v-14h-14v14h-2v-16h18v1zM0 92.1A5.02 5.02 0 0 1 6 97a5 5 0 0 1-6 4.9v-2.07a3 3 0 1 0 0-5.66V92.1zM80 272h2v32h-2v-32zm37.9 32h-2.07a3 3 0 0 0-5.66 0h-2.07a5 5 0 0 1 9.8 0zM5.9 0A5.02 5.02 0 0 1 0 5.9V3.83A3 3 0 0 0 3.83 0H5.9zm294.2 0h2.07A3 3 0 0 0 304 3.83V5.9a5 5 0 0 1-3.9-5.9zm3.9 300.1v2.07a3 3 0 0 0-1.83 1.83h-2.07a5 5 0 0 1 3.9-3.9zM97 100a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-48 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 96a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-144a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-96 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm96 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-32 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM49 36a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-32 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM33 68a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 240a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm80-176a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm112 176a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM17 180a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM17 84a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6z'%3E%3C/path%3E%3C/svg%3E&#34;)">You read the whole thing.
Back <a class=underline href=#very-top>to the top</a>?</div></main><footer><div class="h-spaced mb-5 mt-12 text-xs text-verysubtle">All content created by Lukas Knuth and licensed under the
<a class="underline text-bold" href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Attribution-ShareAlike 4.0 International License</a>.
All source code is licensed <a class=underline href=https://opensource.org/license/mit>MIT</a>.
Zu <a class="underline text-bold" href=/impressum>Impressum und Datenschutz</a>, vom deutschen Gesetz vorgeschrieben.</div></footer></body></html>