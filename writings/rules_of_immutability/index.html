<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Lukas Knuth"><meta name=description content="In a perfect world, every value container (an object that only holds multiple fields of data and defines methods for access) is immutable. Immutability should always be a design-goal, especially, when creating a library or API.
In this article, I&amp;rsquo;m going to explain what immutable objects are, why they are cool and what stumbling blocks you should watch out for."><meta property="og:description" value="In a perfect world, every value container (an object that only holds multiple fields of data and defines methods for access) is immutable. Immutability should always be a design-goal, especially, when creating a library or API.
In this article, I&amp;rsquo;m going to explain what immutable objects are, why they are cool and what stumbling blocks you should watch out for."><meta property="og:title" value="Rules of Immutability"><meta property="og:url" value=https://lknuth.dev/writings/rules_of_immutability/><meta property="og:type" value=article><meta property="og:article:author" value="Lukas Knuth"><meta property="og:article:published_time" value=2012-07-17T22:00:00+0100><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><title>Rules of Immutability | Lukas Knuth</title>
<link rel=canonical href=https://lknuth.dev/writings/rules_of_immutability/><link rel="stylesheet" href="/css/main.dc6b5960ef6330bab82a32397352a25e1929cbee4eeb38bda23309440921532a.css" integrity="sha256-3GtZYO9jMLq4KjI5c1KiXhkpy&#43;5O6zi9ojMJRAkhUyo=" crossorigin="anonymous">
<link rel=icon type=image/png href=https://lknuth.dev/images/favicon-96x96.png sizes=96x96><link rel=icon type=image/svg+xml href=https://lknuth.dev/images/favicon.svg><link rel="shortcut icon" href=https://lknuth.dev/images/favicon.ico><link rel=alternate type=application/rss+xml href=https://lknuth.dev/writings/index.xml title=Writings></head><body id=very-top class="flex flex-col h-screen max-w-6xl container mx-auto bg-pane break-words text-base text-writing md:text-lg antialiased hyphens-auto leading-relaxed font-sans"><header><div class="h-spaced mt-4 md:mt-6 mb-3"><a href=https://lknuth.dev/><div class="w-16 h-16 mr-3 md:mr-5 float-left bg-no-repeat bg-center bg-contain rounded-md" style=background-image:url(https://lknuth.dev/images/favicon.svg)></div><div class="hidden md:!block text-3xl font-bold"><span>Lukas Knuth</span><span class="pl-1 pr-3 tracking-[-0.3em]">//</span><span>Software Engineer</span></div><div class="md:hidden text-xl font-bold truncate text-clip"><span>Lukas Knuth</span><span class="pl-1 pr-2 tracking-[-0.3em]">//</span><span>SWE</span></div></a><nav><ol class="flex text-primary pt-1"><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/writings>Writings</a></li><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/about>About</a></li><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/cv>CV</a></li><li class="md:text-base inline-block leading-4 mt-1 pr-2 mr-2 md:pr-3 md:mr-3 align-middle border-dotted border-r-2 last:border-none"><a href=/now>Now</a></li></ol></nav></div></header><main class=grow><article class="h-spaced mt-4 md:mt-6" itemscope itemtype=http://schema.org/BlogPosting><h1 class="text-3xl font-light text-subtle" itemprop="name headline">Rules of Immutability</h1><div class="my-2 text-sm text-subtle grid grid-cols-1 sm:block"><span class=inline-block>Posted: <time datetime="2012-07-17 22:00:00 +0100 +0100" itemprop=datePublished>2012-07-17</time></span>
<span class="inline-block sm:pl-5">Updated: <time datetime="2025-06-10 16:38:55 +0200 +0200" itemprop=dateModified>2025-06-10</time></span></div><div class=prose itemprop=articleBody><p>In a perfect world, every <em>value container</em> (an object that only holds multiple fields of data and defines methods for access) is immutable. Immutability should always be a design-goal, especially, when creating a library or API.</p><p>In this article, I&rsquo;m going to explain what immutable objects are, why they are cool and what stumbling blocks you should watch out for.</p><blockquote class=callout><div>ðŸ“–</div><div><p>Although the idea of immutability is applicable to most programming languages, specifics vary greatly.
More functional languages usually enforce immutability at the language level while imperative languages allow you to opt-in as needed.</p><p>The following article is focused on <strong>Java 7</strong>, but the ideas discussed are transferable to other languages.</p></div></blockquote><h2 id=what-makes-an-object-immutable><a href=#what-makes-an-object-immutable>What makes an object &ldquo;immutable&rdquo;?</a></h2><p><a href=http://en.wikipedia.org/wiki/Immutable_object rel=external>Wikipedia</a> boils it down to one simple sentence:</p><blockquote><p>In object-oriented and functional programming, an immutable object is <strong>an object whose state cannot be modified
after it is created.</strong></p></blockquote><p>Let&rsquo;s look at an example:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d20f39>public</span> <span style=color:#d20f39>final</span> <span style=color:#d20f39>class</span> <span style=color:#df8e1d>GeoTag</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>private</span> <span style=color:#d20f39>final</span> <span style=color:#d20f39>int</span> latitude;
</span></span><span style=display:flex><span>    <span style=color:#d20f39>private</span> <span style=color:#d20f39>final</span> <span style=color:#d20f39>int</span> longitude;
</span></span><span style=display:flex><span>    <span style=color:#d20f39>private</span> <span style=color:#d20f39>final</span> Date timestamp;
</span></span><span style=display:flex><span>    <span style=color:#d20f39>private</span> <span style=color:#d20f39>final</span> String message;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> <span style=color:#1e66f5>GeoTag</span>(<span style=color:#d20f39>int</span> latitude, <span style=color:#d20f39>int</span> longitude, Date timestamp, String message) {
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>latitude</span> <span style=color:#04a5e5;font-weight:700>=</span> latitude;
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>longitude</span> <span style=color:#04a5e5;font-weight:700>=</span> longitude;
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>timestamp</span> <span style=color:#04a5e5;font-weight:700>=</span> timestamp;
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>message</span> <span style=color:#04a5e5;font-weight:700>=</span> message;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> <span style=color:#d20f39>int</span> <span style=color:#1e66f5>getLatitude</span>() {
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> latitude;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> <span style=color:#d20f39>int</span> <span style=color:#1e66f5>getLongitude</span>() {
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> longitude;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> Date <span style=color:#1e66f5>getTimestamp</span>() {
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> timestamp;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> String <span style=color:#1e66f5>getMessage</span>() {
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> message;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is a class which encapsulates multiple values into one single object. It provides geographical information for a message, including latitude and longitude, the date of creation and the message itself.</p><p>An instance of this class can only be created by using it&rsquo;s constructor (which initializes and populates all fields with the given values). After the instance is created, there is no way to change any of those values, since no <em>setter</em>-methods are available.</p><p>By doing so, we can assure that this object can not be manipulated after it&rsquo;s creation. But what are the benefits of doing so?</p><h3 id=why-immutability-is-cool><a href=#why-immutability-is-cool>Why immutability is cool</a></h3><p>As pointed out above, the object can not be manipulated or changed in any way after it was created. This ensures the <em>consistency</em> of the instance across the whole application.</p><p>You can access an immutable objects on multiple threads simultaneously, without the fear of any concurrent modification by another thread. Immutable objects are always synchronized. No extra work is needed.</p><p>This makes passing objects around multiple threads or across multiple application-modules simple. It&rsquo;s the easiest approach to thread-safety.</p><p>Also, immutable objects make for the perfect <code>Map</code>-keys, because you don&rsquo;t have to worry about their values (and therefor the key) changing, which would destroy the Maps invariants.</p><h2 id=designing-immutable-objects><a href=#designing-immutable-objects>Designing immutable objects</a></h2><p>In this section, I&rsquo;m going to give some design-advices and show some possible weak-spots.</p><h3 id=finalize-to-freeze-the-state><a href=#finalize-to-freeze-the-state>Finalize to freeze the state</a></h3><p>Let&rsquo;s take a closer look. Notice how all the fields are declared to be <code>private final</code>? A field declared <code>final</code> can&rsquo;t be assigned outside of the constructor.</p><p>This secures any primitive value-type as much as possible. Since the primitive types don&rsquo;t offer any methods to mutate their state, they are now immutable.</p><h3 id=prevent-extensibility><a href=#prevent-extensibility>Prevent extensibility</a></h3><p>We also declared the class itself to be <code>final</code>. <em>Finalized</em> classes can&rsquo;t be extended, which freezes their internals from being manipulated. For example, an &ldquo;attacker&rdquo; could create a subclass of our <code>GeoTag</code>-class and make it mutable:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d20f39>public</span> <span style=color:#d20f39>class</span> <span style=color:#df8e1d>GeoTagMutable</span> <span style=color:#d20f39>extends</span> GeoTag {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>private</span> <span style=color:#d20f39>int</span> mLatitude;
</span></span><span style=display:flex><span>    <span style=color:#d20f39>private</span> <span style=color:#d20f39>int</span> mLongitude;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> <span style=color:#1e66f5>GeoTagMutable</span>(<span style=color:#d20f39>int</span> latitude, <span style=color:#d20f39>int</span> longitude, Date timestamp, String message) {
</span></span><span style=display:flex><span>        <span style=color:#d20f39>super</span>(latitude, longitude, timestamp, message);
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>mLatitude</span> <span style=color:#04a5e5;font-weight:700>=</span> latitude;
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>mLongitude</span> <span style=color:#04a5e5;font-weight:700>=</span> longitude;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#9ca0b0;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic>        * Copy-constructor to make an &lt;i&gt;immutable&lt;/i&gt; instance &lt;i&gt;mutable&lt;/i&gt;.
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic>        */</span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> <span style=color:#1e66f5>GeoTagMutable</span>(GeoTag immutable_tag){
</span></span><span style=display:flex><span>        <span style=color:#d20f39>super</span>(immutable_tag.<span style=color:#1e66f5>getLatitude</span>(), immutable_tag.<span style=color:#1e66f5>getLongitude</span>(),
</span></span><span style=display:flex><span>                immutable_tag.<span style=color:#1e66f5>getTimestamp</span>(), immutable_tag.<span style=color:#1e66f5>getMessage</span>()
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>mLatitude</span> <span style=color:#04a5e5;font-weight:700>=</span> immutable_tag.<span style=color:#1e66f5>getLatitude</span>();
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>mLongitude</span> <span style=color:#04a5e5;font-weight:700>=</span> immutable_tag.<span style=color:#1e66f5>getLongitude</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#1e66f5;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> <span style=color:#d20f39>int</span> <span style=color:#1e66f5>getLatitude</span>() {
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> mLatitude;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#1e66f5;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> <span style=color:#d20f39>int</span> <span style=color:#1e66f5>getLongitude</span>() {
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> mLongitude;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> <span style=color:#d20f39>void</span> <span style=color:#1e66f5>setLatitude</span>(<span style=color:#d20f39>int</span> latitude) {
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>mLatitude</span> <span style=color:#04a5e5;font-weight:700>=</span> latitude;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> <span style=color:#d20f39>void</span> <span style=color:#1e66f5>setLongitude</span>(<span style=color:#d20f39>int</span> longitude) {
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>mLongitude</span> <span style=color:#04a5e5;font-weight:700>=</span> longitude;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The extending <code>GeoTagMutable</code>-class uses it&rsquo;s own, non-final fields for latitude and longitude. It overrides the <code>getLatitude()</code> and <code>getLongitude()</code>-methods to return it&rsquo;s own fields and offers two setter methods for them, too. Using the new class, we can now create new, <em>mutable</em> <code>GeoTag</code> objects and, we can change an existing, <em>immutable</em> object, to a <em>mutable</em> one:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>GeoTag tag <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> GeoTag(12, 14, <span style=color:#8839ef>new</span> Date(), <span style=color:#40a02b>&#34;Some message!&#34;</span>);
</span></span><span style=display:flex><span>GeoTagMutable mutableTag <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> GeoTagMutable(tag);
</span></span><span style=display:flex><span>mutableTag.<span style=color:#1e66f5>setLatitude</span>(41);
</span></span><span style=display:flex><span>System.<span style=color:#1e66f5>out</span>.<span style=color:#1e66f5>println</span>(tag.<span style=color:#1e66f5>getLatitude</span>()<span style=color:#04a5e5;font-weight:700>+</span><span style=color:#40a02b>&#34; &gt; &#34;</span><span style=color:#04a5e5;font-weight:700>+</span>mutableTag.<span style=color:#1e66f5>getLatitude</span>());
</span></span></code></pre></div><p>To prevent this kind of &ldquo;attack&rdquo;, we declare the class to be <code>final</code>.</p><h3 id=mutable-components-in-immutable-objects><a href=#mutable-components-in-immutable-objects>Mutable components in immutable objects</a></h3><p>But the <code>GeoTag</code>-class is <strong>not perfect</strong>. It is possible to mutate the <code>timestamp</code>-field. See the following example &ldquo;attack&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>Calendar calendar <span style=color:#04a5e5;font-weight:700>=</span> Calendar.<span style=color:#1e66f5>getInstance</span>();
</span></span><span style=display:flex><span>calendar.<span style=color:#1e66f5>set</span>(1999, 12, 24);
</span></span><span style=display:flex><span>GeoTag tag <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> GeoTag(12, 14, calendar.<span style=color:#1e66f5>getTime</span>(), <span style=color:#40a02b>&#34;Some message!&#34;</span>);
</span></span><span style=display:flex><span>tag.<span style=color:#1e66f5>getTimestamp</span>().<span style=color:#1e66f5>setDate</span>(30);
</span></span><span style=display:flex><span>tag.<span style=color:#1e66f5>getTimestamp</span>().<span style=color:#1e66f5>setMonth</span>(10);
</span></span><span style=display:flex><span>System.<span style=color:#1e66f5>out</span>.<span style=color:#1e66f5>println</span>(<span style=color:#40a02b>&#34;GeoTag taken on: &#34;</span><span style=color:#04a5e5;font-weight:700>+</span>tag.<span style=color:#1e66f5>getTimestamp</span>().<span style=color:#1e66f5>toLocaleString</span>());
</span></span></code></pre></div><p>This gives us the following output:</p><blockquote><p>GeoTag taken on: 30.10.1999 00:00:00</p></blockquote><p>Congratulations. You just traveled back in time from christmas to halloween. But for our goal of immutability, not that cool. The problem here is not our object (which is quite immutable), but the <code>Date</code>-object, which is not immutable.</p><p>To overcome this problem, we&rsquo;ll need to make <em>defensive copies</em> of our &ldquo;timestamp&rdquo;.</p><h2 id=making-defensive-copies><a href=#making-defensive-copies>Making <em>defensive copies</em></a></h2><p>As shown above, a mutable object can be changed, due to the fact that Java passes around object-<em>references</em> to method-calls (more on the &ldquo;pass-by-reference&rdquo; and &ldquo;pass-by-value&rdquo; stuff can be found <a href=http://stackoverflow.com/q/40480/717341 rel=external>here</a>).</p><p>To overcome this, the <code>getTimestamp()</code>-method will now be implemented to use defensive copies. This is as easy as doing the following:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d20f39>public</span> Date <span style=color:#1e66f5>getTimestamp</span>() {
</span></span><span style=display:flex><span>    <span style=color:#8839ef>return</span> <span style=color:#8839ef>new</span> Date(timestamp.<span style=color:#1e66f5>getTime</span>());
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>What happens here? Instead of giving out a reference to our internal <code>Date</code>-object, we create a new Date-instance (with the same time as our internal one) and return it. This will preserve the original date, but protect us from the above explained &ldquo;attack&rdquo;. Run the code again and see for yourself:</p><blockquote><p>GeoTag taken on: 24.12.1999 00:00:00</p></blockquote><p>The timestamp is unchanged, because we didn&rsquo;t give out our internal reference. So, now our <code>GeoTag</code>-class is save, right? Wrong!</p><p>Here is the new &ldquo;attack&rdquo;, suffering from the same problem:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>Calendar calendar <span style=color:#04a5e5;font-weight:700>=</span> Calendar.<span style=color:#1e66f5>getInstance</span>();
</span></span><span style=display:flex><span>calendar.<span style=color:#1e66f5>set</span>(1999, 12, 24);
</span></span><span style=display:flex><span>Date time <span style=color:#04a5e5;font-weight:700>=</span> calendar.<span style=color:#1e66f5>getTime</span>();
</span></span><span style=display:flex><span>GeoTag tag <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> GeoTag(12, 14, time, <span style=color:#40a02b>&#34;Some message!&#34;</span>);
</span></span><span style=display:flex><span>time.<span style=color:#1e66f5>setDate</span>(30);
</span></span><span style=display:flex><span>time.<span style=color:#1e66f5>setMonth</span>(10);
</span></span><span style=display:flex><span>System.<span style=color:#1e66f5>out</span>.<span style=color:#1e66f5>println</span>(<span style=color:#40a02b>&#34;GeoTag taken on: &#34;</span><span style=color:#04a5e5;font-weight:700>+</span>tag.<span style=color:#1e66f5>getTimestamp</span>().<span style=color:#1e66f5>toLocaleString</span>());
</span></span></code></pre></div><p>And once again, the output is:</p><blockquote><p>GeoTag taken on: 30.10.1999 00:00:00</p></blockquote><p>Our <code>getTimestamp()</code>-method might be secure now, but the <code>Date</code>-instance, given to our constructor, can still be manipulated (since we&rsquo;re storing a reference to it). To prevent this attack, we&rsquo;ll need to make a defensive copy in our constructor, too:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d20f39>public</span> <span style=color:#1e66f5>GeoTag</span>(<span style=color:#d20f39>int</span> latitude, <span style=color:#d20f39>int</span> longitude, Date timestamp, String message) {
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>latitude</span> <span style=color:#04a5e5;font-weight:700>=</span> latitude;
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>longitude</span> <span style=color:#04a5e5;font-weight:700>=</span> longitude;
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>timestamp</span> <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> Date(timestamp.<span style=color:#1e66f5>getTime</span>()); <span style=color:#9ca0b0;font-style:italic>// Defensive copy</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>message</span> <span style=color:#04a5e5;font-weight:700>=</span> message;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, the first and the second attack show no effects. Our class is now truly <em>immutable</em>.</p><p>A quick word on performance: Yes, making defensive copies (which might happen quite often) can result in many object-creations and therefor much GC-activity. In general however, the correctness of your program should outweigh any perceived performance problems. Always measure the performance impact before concerning yourself with possible performance issues prematurely!</p><h3 id=dont-use-clone-for-defensive-copies><a href=#dont-use-clone-for-defensive-copies>Don&rsquo;t use <code>clone()</code> for defensive copies!</a></h3><p>There is yet another possible &ldquo;attack&rdquo;, which can be used to manipulate the timestamp, before it is stored in the field. This &ldquo;attack&rdquo; uses the <code>clone()</code>-method of <code>Date</code>, which gets overloaded to manipulate the freshly cloned object:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d20f39>public</span> <span style=color:#d20f39>class</span> <span style=color:#df8e1d>DateCloneAttack</span> <span style=color:#d20f39>extends</span> Date <span style=color:#d20f39>implements</span> Cloneable{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> <span style=color:#1e66f5>DateCloneAttack</span>(Date date){
</span></span><span style=display:flex><span>        <span style=color:#d20f39>super</span>(date.<span style=color:#1e66f5>getTime</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#9ca0b0;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic>        * This method clones a {@code Date} and manipulates it.
</span></span></span><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic>        */</span>
</span></span><span style=display:flex><span>    <span style=color:#1e66f5;font-weight:700>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#d20f39>public</span> Date <span style=color:#1e66f5>clone</span>(){
</span></span><span style=display:flex><span>        Date result <span style=color:#04a5e5;font-weight:700>=</span> (Date) <span style=color:#d20f39>super</span>.<span style=color:#1e66f5>clone</span>();
</span></span><span style=display:flex><span>        result.<span style=color:#1e66f5>setDate</span>(30);
</span></span><span style=display:flex><span>        result.<span style=color:#1e66f5>setMonth</span>(10);
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To make the attack work (and show why you shouldn&rsquo;t use clone for defensive copies), let&rsquo;s change the constructor to use the <code>clone()</code>-method of what seems to be a <code>Date</code>-object:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#9ca0b0;font-style:italic>// Bad practice example. DON&#39;T DO THIS!</span>
</span></span><span style=display:flex><span><span style=color:#d20f39>public</span> <span style=color:#1e66f5>GeoTag</span>(<span style=color:#d20f39>int</span> latitude, <span style=color:#d20f39>int</span> longitude, Date timestamp, String message) {
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>latitude</span> <span style=color:#04a5e5;font-weight:700>=</span> latitude;
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>longitude</span> <span style=color:#04a5e5;font-weight:700>=</span> longitude;
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>timestamp</span> <span style=color:#04a5e5;font-weight:700>=</span> (Date) timestamp.<span style=color:#1e66f5>clone</span>();
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span>.<span style=color:#1e66f5>message</span> <span style=color:#04a5e5;font-weight:700>=</span> message;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, it&rsquo;s possible to change the <code>Date</code>-object, which is passed to the constructor, after it is passed:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span>Calendar calendar <span style=color:#04a5e5;font-weight:700>=</span> Calendar.<span style=color:#1e66f5>getInstance</span>();
</span></span><span style=display:flex><span>calendar.<span style=color:#1e66f5>set</span>(1999, 12, 24);
</span></span><span style=display:flex><span>DateCloneAttack attack <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> DateCloneAttack(calendar.<span style=color:#1e66f5>getTime</span>());
</span></span><span style=display:flex><span>GeoTag tag <span style=color:#04a5e5;font-weight:700>=</span> <span style=color:#8839ef>new</span> GeoTag(12, 14, attack, <span style=color:#40a02b>&#34;Some message!&#34;</span>);
</span></span><span style=display:flex><span>System.<span style=color:#1e66f5>out</span>.<span style=color:#1e66f5>println</span>(<span style=color:#40a02b>&#34;GeoTag taken on: &#34;</span><span style=color:#04a5e5;font-weight:700>+</span>tag.<span style=color:#1e66f5>getTimestamp</span>().<span style=color:#1e66f5>toLocaleString</span>());
</span></span></code></pre></div><p>This will print out:</p><blockquote><p>GeoTag taken on: 30.10.1999 00:00:00</p></blockquote><p>The lesson here is, that you can&rsquo;t trust the user. If the <code>Date</code>-class would have been <em>finalized</em>, creating a manipulated <code>clone()</code>-method would have been impossible.</p><p>In an actual, real-live example, this attack could smuggle an invalid object around the validity tests and modify it afterwards, leaving the new object in an invalid state. Therefore, check for validity <em>after</em> cloning or recreating your mutable parameters (on the defensive copies).</p><p>Although you might use a mix of both: In the constructor, recreate the object using it&rsquo;s constructor. When giving the object out (in it&rsquo;s getter-method), you can use <code>clone()</code>, because you already have a validated copy of it. But, since cloning objects does not necessarily result in any kind of performance-increase, but rather makes your code more error prone, <strong>you should not use <code>clone()</code> if possible</strong>.</p><h3 id=strings-are-immutable><a href=#strings-are-immutable>Strings are immutable</a></h3><p>You might wonder why we need to make a defensive copy of the <code>Date</code>, but not the <code>String</code>-object. This is, because <code>String</code> itself is immutable. Quoting from it&rsquo;s <a href=http://docs.oracle.com/javase/6/docs/api/java/lang/String.html rel=external>JavaDoc</a>:</p><blockquote><p>Strings are constant; their values cannot be changed after they are created. String buffers support mutable strings.
Because <strong>String objects are immutable</strong> they can be shared [&mldr;]</p></blockquote><p>A more detailed explanation might be found on the linked documentation page.</p><h2 id=changing-a-geotag><a href=#changing-a-geotag>Changing a <code>GeoTag</code></a></h2><p>An object that can&rsquo;t be modified is pretty boring. What if you <em>do</em> have legit reasons to change certain fields, for example if you want to make the message editable?</p><p>Let&rsquo;s write a setter method for message that <strong>still leaves the object immutable</strong>:</p><div class=highlight><pre tabindex=0 style=color:#4c4f69;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#d20f39>public</span> GeoTag <span style=color:#1e66f5>setMessage</span>(String newMessage) {
</span></span><span style=display:flex><span>  <span style=color:#8839ef>return</span> <span style=color:#8839ef>new</span> GeoTag(getLatitude(), getLongitude(), getTimestamp(), newMessage);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The setter <strong>does not modify the object</strong> but instead returns a new object with the modified message. This means that references to the original <code>GeoTag</code> are still valid (and will still show the old message), but now there is a new object with the same latitude/longitude/timestamp and a new message.</p><p>Of course this means that any code that is currently working with the old object will not see this change. But remember that this is exactly what we wanted, specifically in a multi-threaded context. In practice, this is rarely a problem because changes to an object require that operations be re-run with the new object anyways. For example, if our <code>GeoTag</code> was being persisted to a database, changing the message would require persisting the change to the database again anyways.</p><h2 id=conclusion><a href=#conclusion>Conclusion</a></h2><p>Make your <em>value containers</em> immutable. It makes writing <em>correct</em> software much easier.</p><p>Here are the five simple rules to create an immutable object in Java, taken from &ldquo;Effective Java - Second Edition&rdquo;, Chapter 4, Item 15:</p><blockquote><ol><li>Don&rsquo;t provide any methods that modify the object&rsquo;s state.</li><li>Ensure that the class can&rsquo;t be extended.</li><li>Make all fields final.</li><li>Make all fields private.</li><li>Ensure exclusive access to any mutable components (defensive copies)</li></ol></blockquote><p>As a sixth rule: <strong>Document immutability</strong>. If you designed a component to be immutable, document so in the JavaDoc of this class.</p></div></article><div class="mt-8 mb-3 py-4 px-5 md:px-9" style="background-image:url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 304 304' width='304' height='304'%3E%3Cpath fill='%23c8c8c8' fill-opacity='0.5' d='M44.1 224a5 5 0 1 1 0 2H0v-2h44.1zm160 48a5 5 0 1 1 0 2H82v-2h122.1zm57.8-46a5 5 0 1 1 0-2H304v2h-42.1zm0 16a5 5 0 1 1 0-2H304v2h-42.1zm6.2-114a5 5 0 1 1 0 2h-86.2a5 5 0 1 1 0-2h86.2zm-256-48a5 5 0 1 1 0 2H0v-2h12.1zm185.8 34a5 5 0 1 1 0-2h86.2a5 5 0 1 1 0 2h-86.2zM258 12.1a5 5 0 1 1-2 0V0h2v12.1zm-64 208a5 5 0 1 1-2 0v-54.2a5 5 0 1 1 2 0v54.2zm48-198.2V80h62v2h-64V21.9a5 5 0 1 1 2 0zm16 16V64h46v2h-48V37.9a5 5 0 1 1 2 0zm-128 96V208h16v12.1a5 5 0 1 1-2 0V210h-16v-76.1a5 5 0 1 1 2 0zm-5.9-21.9a5 5 0 1 1 0 2H114v48H85.9a5 5 0 1 1 0-2H112v-48h12.1zm-6.2 130a5 5 0 1 1 0-2H176v-74.1a5 5 0 1 1 2 0V242h-60.1zm-16-64a5 5 0 1 1 0-2H114v48h10.1a5 5 0 1 1 0 2H112v-48h-10.1zM66 284.1a5 5 0 1 1-2 0V274H50v30h-2v-32h18v12.1zM236.1 176a5 5 0 1 1 0 2H226v94h48v32h-2v-30h-48v-98h12.1zm25.8-30a5 5 0 1 1 0-2H274v44.1a5 5 0 1 1-2 0V146h-10.1zm-64 96a5 5 0 1 1 0-2H208v-80h16v-14h-42.1a5 5 0 1 1 0-2H226v18h-16v80h-12.1zm86.2-210a5 5 0 1 1 0 2H272V0h2v32h10.1zM98 101.9V146H53.9a5 5 0 1 1 0-2H96v-42.1a5 5 0 1 1 2 0zM53.9 34a5 5 0 1 1 0-2H80V0h2v34H53.9zm60.1 3.9V66H82v64H69.9a5 5 0 1 1 0-2H80V64h32V37.9a5 5 0 1 1 2 0zM101.9 82a5 5 0 1 1 0-2H128V37.9a5 5 0 1 1 2 0V82h-28.1zm16-64a5 5 0 1 1 0-2H146v44.1a5 5 0 1 1-2 0V18h-26.1zm102.2 270a5 5 0 1 1 0 2H98v14h-2v-16h124.1zM242 149.9V160h16v34h-16v62h48v48h-2v-46h-48v-66h16v-30h-16v-12.1a5 5 0 1 1 2 0zM53.9 18a5 5 0 1 1 0-2H64V2H48V0h18v18H53.9zm112 32a5 5 0 1 1 0-2H192V0h50v2h-48v48h-28.1zm-48-48a5 5 0 0 1-9.8-2h2.07a3 3 0 1 0 5.66 0H178v34h-18V21.9a5 5 0 1 1 2 0V32h14V2h-58.1zm0 96a5 5 0 1 1 0-2H137l32-32h39V21.9a5 5 0 1 1 2 0V66h-40.17l-32 32H117.9zm28.1 90.1a5 5 0 1 1-2 0v-76.51L175.59 80H224V21.9a5 5 0 1 1 2 0V82h-49.59L146 112.41v75.69zm16 32a5 5 0 1 1-2 0v-99.51L184.59 96H300.1a5 5 0 0 1 3.9-3.9v2.07a3 3 0 0 0 0 5.66v2.07a5 5 0 0 1-3.9-3.9H185.41L162 121.41v98.69zm-144-64a5 5 0 1 1-2 0v-3.51l48-48V48h32V0h2v50H66v55.41l-48 48v2.69zM50 53.9v43.51l-48 48V208h26.1a5 5 0 1 1 0 2H0v-65.41l48-48V53.9a5 5 0 1 1 2 0zm-16 16V89.41l-34 34v-2.82l32-32V69.9a5 5 0 1 1 2 0zM12.1 32a5 5 0 1 1 0 2H9.41L0 43.41V40.6L8.59 32h3.51zm265.8 18a5 5 0 1 1 0-2h18.69l7.41-7.41v2.82L297.41 50H277.9zm-16 160a5 5 0 1 1 0-2H288v-71.41l16-16v2.82l-14 14V210h-28.1zm-208 32a5 5 0 1 1 0-2H64v-22.59L40.59 194H21.9a5 5 0 1 1 0-2H41.41L66 216.59V242H53.9zm150.2 14a5 5 0 1 1 0 2H96v-56.6L56.6 162H37.9a5 5 0 1 1 0-2h19.5L98 200.6V256h106.1zm-150.2 2a5 5 0 1 1 0-2H80v-46.59L48.59 178H21.9a5 5 0 1 1 0-2H49.41L82 208.59V258H53.9zM34 39.8v1.61L9.41 66H0v-2h8.59L32 40.59V0h2v39.8zM2 300.1a5 5 0 0 1 3.9 3.9H3.83A3 3 0 0 0 0 302.17V256h18v48h-2v-46H2v42.1zM34 241v63h-2v-62H0v-2h34v1zM17 18H0v-2h16V0h2v18h-1zm273-2h14v2h-16V0h2v16zm-32 273v15h-2v-14h-14v14h-2v-16h18v1zM0 92.1A5.02 5.02 0 0 1 6 97a5 5 0 0 1-6 4.9v-2.07a3 3 0 1 0 0-5.66V92.1zM80 272h2v32h-2v-32zm37.9 32h-2.07a3 3 0 0 0-5.66 0h-2.07a5 5 0 0 1 9.8 0zM5.9 0A5.02 5.02 0 0 1 0 5.9V3.83A3 3 0 0 0 3.83 0H5.9zm294.2 0h2.07A3 3 0 0 0 304 3.83V5.9a5 5 0 0 1-3.9-5.9zm3.9 300.1v2.07a3 3 0 0 0-1.83 1.83h-2.07a5 5 0 0 1 3.9-3.9zM97 100a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-48 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 96a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-144a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-96 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm96 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-32 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM49 36a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-32 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM33 68a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 240a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm80-176a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 48a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm112 176a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-16 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM17 180a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0-32a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16 0a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM17 84a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm32 64a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm16-16a3 3 0 1 0 0-6 3 3 0 0 0 0 6z'%3E%3C/path%3E%3C/svg%3E&#34;)">You read the whole thing.
Back <a class=underline href=#very-top>to the top</a>?</div></main><footer><div class="h-spaced mb-5 mt-12 text-xs text-verysubtle">All content created by Lukas Knuth and licensed under the
<a class="underline text-bold" href=https://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Attribution-ShareAlike 4.0 International License</a>.
All source code is licensed <a class=underline href=https://opensource.org/license/mit>MIT</a>.
Zu <a class="underline text-bold" href=/impressum>Impressum und Datenschutz</a>, vom deutschen Gesetz vorgeschrieben.</div></footer></body></html>