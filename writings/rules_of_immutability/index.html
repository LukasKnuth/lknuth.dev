<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/iAWriterQuattro/iAWriterQuattroS-Bold.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/iAWriterQuattro/iAWriterQuattroS-BoldItalic.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/iAWriterQuattro/iAWriterQuattroS-Italic.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/iAWriterQuattro/iAWriterQuattroS-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Rules of Immutability | Lukas Knuth // Developer</title><link rel=canonical href=https://lknuth.dev/writings/rules_of_immutability/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Rules of Immutability"><meta property="og:description" content="About mutable and immutable objects and defensive copying."><meta property="og:type" content="article"><meta property="og:url" content="https://lknuth.dev/writings/rules_of_immutability/"><meta property="article:section" content="writings"><meta property="article:published_time" content="2012-07-17T22:00:00+01:00"><meta property="article:modified_time" content="2012-07-17T22:00:00+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Rules of Immutability"><meta name=twitter:description content="About mutable and immutable objects and defensive copying."><link rel=stylesheet href=https://lknuth.dev/css/styles.b80ba81354db091030af4b414bd9c1e0d6f77eb68cfa9470c580bd78bb96e7ae8b9ab256585ee48b3450eb59ff26dea067f26ae15be318c24227a3ea1145bf99.css integrity="sha512-uAuoE1TbCRAwr0tBS9nB4Nb3fraM+pRwxYC9eLuW566LmrJWWF7kizRQ61n/Jt6gZ/Jq4VvjGMJCJ6PqEUW/mQ=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://lknuth.dev/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://lknuth.dev/><div id=logo style=background-image:url(https://lknuth.dev/images/logo.png)></div><div id=title><h1>Lukas Knuth // Developer</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/writings>Writings</a></li><li><a href=/about>About</a></li><li><a href=/cv>CV</a></li><li><a href=/imprint>Imprint</a></li></ul></div></header><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Rules of Immutability</h1><div class=meta><div class=postdate><time datetime="2012-07-17 22:00:00 +0100 +0100" itemprop=datePublished>2012-07-17</time></div></div></header><div class=content itemprop=articleBody><p>In a perfect world, every <em>value container</em> (an object that only holds multiple fields of data and defines methods for access) is immutable. Immutability should always be a design-goal, especially, when creating a library or API.</p><p>In this article, I&rsquo;m going to explain what immutable objects are, why they are cool and what stumbling blocks you should watch out for.</p><div class=important><p>Although immutability, as a design-pattern, has no origin in any particular language, the following examples (and most of the writing) <b>focus on the situation in the Java programming language</b> and <i>might</i> not hold for other languages.</p><p>For examples in other programming languages, the below linked <a href=http://en.wikipedia.org/wiki/Immutable_object#Implementation>Wikipedia article</a> can be consulted, although it's not that extensive as the following exposition.</p></div><h2 id=what-makes-an-object-immutable>What makes an object &ldquo;immutable&rdquo;?</h2><p><a href=http://en.wikipedia.org/wiki/Immutable_object>Wikipedia</a> boils it down to one simple sentence:</p><blockquote><p>In object-oriented and functional programming, an immutable object is <strong>an object whose state cannot be modified
after it is created.</strong></p></blockquote><p>Let&rsquo;s look at an example:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8839ef>public</span> <span style=color:#8839ef>final</span> <span style=color:#8839ef>class</span> <span style=color:#df8e1d>GeoTag</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>private</span> <span style=color:#8839ef>final</span> <span style=color:#df8e1d>int</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>private</span> <span style=color:#8839ef>final</span> <span style=color:#df8e1d>int</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>private</span> <span style=color:#8839ef>final</span> <span style=color:#7287fd>Date</span> <span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>private</span> <span style=color:#8839ef>final</span> <span style=color:#7287fd>String</span> <span style=color:#7287fd>message</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#04a5e5>GeoTag</span><span style=color:#04a5e5>(</span><span style=color:#df8e1d>int</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>,</span> <span style=color:#df8e1d>int</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>Date</span> <span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>String</span> <span style=color:#7287fd>message</span><span style=color:#04a5e5>)</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>latitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>longitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>timestamp</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>message</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>message</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#df8e1d>int</span> <span style=color:#04a5e5>getLatitude</span><span style=color:#04a5e5>()</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#df8e1d>int</span> <span style=color:#04a5e5>getLongitude</span><span style=color:#04a5e5>()</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#7287fd>Date</span> <span style=color:#04a5e5>getTimestamp</span><span style=color:#04a5e5>()</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> <span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#7287fd>String</span> <span style=color:#04a5e5>getMessage</span><span style=color:#04a5e5>()</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> <span style=color:#7287fd>message</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>}</span>
</span></span></code></pre></div><p>This is a class which encapsulates multiple values into one single object. It provides geographical information for a message, including latitude and longitude, the date of creation and the message itself.</p><p>An instance of this class can only be created by using it&rsquo;s constructor (which initializes and populates all fields with the given values). After the instance is created, there is no way to change any of those values, since no <em>setter</em>-methods are available.</p><p>By doing so, we can assure that this object can not be manipulated after it&rsquo;s creation. But what are the benefits of doing so?</p><h3 id=why-immutability-is-cool>Why immutability is cool</h3><p>As pointed out above, the object can not be manipulated or changed in any way after it was created. This ensures the <em>consistency</em> of the instance across the whole application.</p><p>You can access an immutable objects on multiple threads simultaneously, without the fear of any concurrent modification by another thread. Immutable objects are always synchronized. No extra work is needed.</p><p>This makes passing objects around multiple threads or across multiple application-modules simple. It&rsquo;s the easiest approach to thread-safety.</p><p>Also, immutable objects make for the perfect <code>Map</code>-keys, because you don&rsquo;t have to worry about their values (and therefor the key) changing, which would destroy the Maps invariants.</p><h2 id=designing-immutable-objects>Designing immutable objects</h2><p>In this section, I&rsquo;m going to give some design-advices and show some possible weak-spots.</p><h3 id=finalize-to-freeze-the-state>Finalize to freeze the state</h3><p>Let&rsquo;s take a closer look. Notice how all the fields are declared to be <code>private final</code>? A field declared <code>final</code> can&rsquo;t be assigned outside of the constructor.</p><p>This secures any primitive value-type as much as possible. Since the primitive types don&rsquo;t offer any methods to mutate their state, they are now immutable.</p><h3 id=prevent-extensibility>Prevent extensibility</h3><p>We also declared the class itself to be <code>final</code>. <em>Finalized</em> classes can&rsquo;t be extended, which freezes their internals from being manipulated. For example, an &ldquo;attacker&rdquo; could create a subclass of our <code>GeoTag</code>-class and make it mutable:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8839ef>public</span> <span style=color:#8839ef>class</span> <span style=color:#df8e1d>GeoTagMutable</span> <span style=color:#8839ef>extends</span> <span style=color:#7287fd>GeoTag</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>private</span> <span style=color:#df8e1d>int</span> <span style=color:#7287fd>mLatitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>private</span> <span style=color:#df8e1d>int</span> <span style=color:#7287fd>mLongitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#04a5e5>GeoTagMutable</span><span style=color:#04a5e5>(</span><span style=color:#df8e1d>int</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>,</span> <span style=color:#df8e1d>int</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>Date</span> <span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>String</span> <span style=color:#7287fd>message</span><span style=color:#04a5e5>)</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>super</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>latitude</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>message</span><span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>mLatitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>mLongitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#acb0be;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#acb0be;font-style:italic>        * Copy-constructor to make an &lt;i&gt;immutable&lt;/i&gt; instance &lt;i&gt;mutable&lt;/i&gt;.
</span></span></span><span style=display:flex><span><span style=color:#acb0be;font-style:italic>        */</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#04a5e5>GeoTagMutable</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>GeoTag</span> <span style=color:#7287fd>immutable_tag</span><span style=color:#04a5e5>){</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>super</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>immutable_tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getLatitude</span><span style=color:#04a5e5>(),</span> <span style=color:#7287fd>immutable_tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getLongitude</span><span style=color:#04a5e5>(),</span>
</span></span><span style=display:flex><span>                <span style=color:#7287fd>immutable_tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTimestamp</span><span style=color:#04a5e5>(),</span> <span style=color:#7287fd>immutable_tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getMessage</span><span style=color:#04a5e5>()</span>
</span></span><span style=display:flex><span>        <span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>mLatitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>immutable_tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getLatitude</span><span style=color:#04a5e5>();</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>mLongitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>immutable_tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getLongitude</span><span style=color:#04a5e5>();</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ea76cb>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#df8e1d>int</span> <span style=color:#04a5e5>getLatitude</span><span style=color:#04a5e5>()</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> <span style=color:#7287fd>mLatitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ea76cb>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#df8e1d>int</span> <span style=color:#04a5e5>getLongitude</span><span style=color:#04a5e5>()</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> <span style=color:#7287fd>mLongitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#df8e1d>void</span> <span style=color:#04a5e5>setLatitude</span><span style=color:#04a5e5>(</span><span style=color:#df8e1d>int</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>)</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>mLatitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#df8e1d>void</span> <span style=color:#04a5e5>setLongitude</span><span style=color:#04a5e5>(</span><span style=color:#df8e1d>int</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>)</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>mLongitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>}</span>
</span></span></code></pre></div><p>The extending <code>GeoTagMutable</code>-class uses it&rsquo;s own, non-final fields for latitude and longitude. It overrides the <code>getLatitude()</code> and <code>getLongitude()</code>-methods to return it&rsquo;s own fields and offers two setter methods for them, too. Using the new class, we can now create new, <em>mutable</em> <code>GeoTag</code> objects and, we can change an existing, <em>immutable</em> object, to a <em>mutable</em> one:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#7287fd>GeoTag</span> <span style=color:#7287fd>tag</span> <span style=color:#04a5e5>=</span> <span style=color:#8839ef>new</span> <span style=color:#7287fd>GeoTag</span><span style=color:#04a5e5>(</span>12<span style=color:#04a5e5>,</span> 14<span style=color:#04a5e5>,</span> <span style=color:#8839ef>new</span> <span style=color:#7287fd>Date</span><span style=color:#04a5e5>(),</span> <span style=color:#40a02b>&#34;Some message!&#34;</span><span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>GeoTagMutable</span> <span style=color:#7287fd>mutableTag</span> <span style=color:#04a5e5>=</span> <span style=color:#8839ef>new</span> <span style=color:#7287fd>GeoTagMutable</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>tag</span><span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>mutableTag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>setLatitude</span><span style=color:#04a5e5>(</span>41<span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>System</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>out</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>println</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getLatitude</span><span style=color:#04a5e5>()+</span><span style=color:#40a02b>&#34; &gt; &#34;</span><span style=color:#04a5e5>+</span><span style=color:#7287fd>mutableTag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getLatitude</span><span style=color:#04a5e5>());</span>
</span></span></code></pre></div><p>To prevent this kind of &ldquo;attack&rdquo;, we declare the class to be <code>final</code>.</p><h3 id=mutable-components-in-immutable-objects>Mutable components in immutable objects</h3><p>But the <code>GeoTag</code>-class is <strong>not perfect</strong>. It is possible to mutate the <code>timestamp</code>-field. See the following example &ldquo;attack&rdquo;:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#7287fd>Calendar</span> <span style=color:#7287fd>calendar</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>Calendar</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getInstance</span><span style=color:#04a5e5>();</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>calendar</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>set</span><span style=color:#04a5e5>(</span>1999<span style=color:#04a5e5>,</span> 12<span style=color:#04a5e5>,</span> 24<span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>GeoTag</span> <span style=color:#7287fd>tag</span> <span style=color:#04a5e5>=</span> <span style=color:#8839ef>new</span> <span style=color:#7287fd>GeoTag</span><span style=color:#04a5e5>(</span>12<span style=color:#04a5e5>,</span> 14<span style=color:#04a5e5>,</span> <span style=color:#7287fd>calendar</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTime</span><span style=color:#04a5e5>(),</span> <span style=color:#40a02b>&#34;Some message!&#34;</span><span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTimestamp</span><span style=color:#04a5e5>().</span><span style=color:#df8e1d>setDate</span><span style=color:#04a5e5>(</span>30<span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTimestamp</span><span style=color:#04a5e5>().</span><span style=color:#df8e1d>setMonth</span><span style=color:#04a5e5>(</span>10<span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>System</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>out</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>println</span><span style=color:#04a5e5>(</span><span style=color:#40a02b>&#34;GeoTag taken on: &#34;</span><span style=color:#04a5e5>+</span><span style=color:#7287fd>tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTimestamp</span><span style=color:#04a5e5>().</span><span style=color:#df8e1d>toLocaleString</span><span style=color:#04a5e5>());</span>
</span></span></code></pre></div><p>This gives us the following output:</p><blockquote><p>GeoTag taken on: 30.10.1999 00:00:00</p></blockquote><p>Congratulations. You just traveled back in time from christmas to halloween. But for our goal of immutability, not that cool. The problem here is not our object (which is quite immutable), but the <code>Date</code>-object, which is not immutable.</p><p>To overcome this problem, we&rsquo;ll need to make <em>defensive copies</em> of our &ldquo;timestamp&rdquo;.</p><h2 id=making-defensive-copies>Making <em>defensive copies</em></h2><p>As shown above, a mutable object can be changed, due to the fact that Java passes around object-<em>references</em> to method-calls (more on the &ldquo;pass-by-reference&rdquo; and &ldquo;pass-by-value&rdquo; stuff can be found <a href=http://stackoverflow.com/q/40480/717341>here</a>).</p><p>To overcome this, the <code>getTimestamp()</code>-method will now be implemented to use defensive copies. This is as easy as doing the following:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8839ef>public</span> <span style=color:#7287fd>Date</span> <span style=color:#04a5e5>getTimestamp</span><span style=color:#04a5e5>()</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>return</span> <span style=color:#8839ef>new</span> <span style=color:#7287fd>Date</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTime</span><span style=color:#04a5e5>());</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>}</span>
</span></span></code></pre></div><p>What happens here? Instead of giving out a reference to our internal <code>Date</code>-object, we create a new Date-instance (with the same time as our internal one) and return it. This will preserve the original date, but protect us from the above explained &ldquo;attack&rdquo;. Run the code again and see for yourself:</p><blockquote><p>GeoTag taken on: 24.12.1999 00:00:00</p></blockquote><p>The timestamp is unchanged, because we didn&rsquo;t give out our internal reference. So, now our <code>GeoTag</code>-class is save, right? Wrong!</p><p>Here is the new &ldquo;attack&rdquo;, suffering from the same problem:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#7287fd>Calendar</span> <span style=color:#7287fd>calendar</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>Calendar</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getInstance</span><span style=color:#04a5e5>();</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>calendar</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>set</span><span style=color:#04a5e5>(</span>1999<span style=color:#04a5e5>,</span> 12<span style=color:#04a5e5>,</span> 24<span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>Date</span> <span style=color:#7287fd>time</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>calendar</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTime</span><span style=color:#04a5e5>();</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>GeoTag</span> <span style=color:#7287fd>tag</span> <span style=color:#04a5e5>=</span> <span style=color:#8839ef>new</span> <span style=color:#7287fd>GeoTag</span><span style=color:#04a5e5>(</span>12<span style=color:#04a5e5>,</span> 14<span style=color:#04a5e5>,</span> <span style=color:#7287fd>time</span><span style=color:#04a5e5>,</span> <span style=color:#40a02b>&#34;Some message!&#34;</span><span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>time</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>setDate</span><span style=color:#04a5e5>(</span>30<span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>time</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>setMonth</span><span style=color:#04a5e5>(</span>10<span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>System</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>out</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>println</span><span style=color:#04a5e5>(</span><span style=color:#40a02b>&#34;GeoTag taken on: &#34;</span><span style=color:#04a5e5>+</span><span style=color:#7287fd>tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTimestamp</span><span style=color:#04a5e5>().</span><span style=color:#df8e1d>toLocaleString</span><span style=color:#04a5e5>());</span>
</span></span></code></pre></div><p>And once again, the output is:</p><blockquote><p>GeoTag taken on: 30.10.1999 00:00:00</p></blockquote><p>Our <code>getTimestamp()</code>-method might be secure now, but the <code>Date</code>-instance, given to our constructor, can still be manipulated (since we&rsquo;re storing a reference to it). To prevent this attack, we&rsquo;ll need to make a defensive copy in our constructor, too:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8839ef>public</span> <span style=color:#04a5e5>GeoTag</span><span style=color:#04a5e5>(</span><span style=color:#df8e1d>int</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>,</span> <span style=color:#df8e1d>int</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>Date</span> <span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>String</span> <span style=color:#7287fd>message</span><span style=color:#04a5e5>)</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>latitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>longitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>timestamp</span> <span style=color:#04a5e5>=</span> <span style=color:#8839ef>new</span> <span style=color:#7287fd>Date</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTime</span><span style=color:#04a5e5>());</span> <span style=color:#acb0be;font-style:italic>// Defensive copy
</span></span></span><span style=display:flex><span><span style=color:#acb0be;font-style:italic></span>    <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>message</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>message</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>}</span>
</span></span></code></pre></div><p>Now, the first and the second attack show no effects. Our class is now truly <em>immutable</em>.</p><p>A quick word on performance: Yes, making defensive copies (which might happen quite often) can result in many object-creations and therefor much GC-activity. In general however, the correctness of your program should outweigh any perceived performance problems. Always measure the performance impact before concerning yourself with possible performance issues prematurely!</p><h3 id=dont-use-clone-for-defensive-copies>Don&rsquo;t use <code>clone()</code> for defensive copies!</h3><p>There is yet another possible &ldquo;attack&rdquo;, which can be used to manipulate the timestamp, before it is stored in the field. This &ldquo;attack&rdquo; uses the <code>clone()</code>-method of <code>Date</code>, which gets overloaded to manipulate the freshly cloned object:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8839ef>public</span> <span style=color:#8839ef>class</span> <span style=color:#df8e1d>DateCloneAttack</span> <span style=color:#8839ef>extends</span> <span style=color:#7287fd>Date</span> <span style=color:#8839ef>implements</span> <span style=color:#7287fd>Cloneable</span><span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#04a5e5>DateCloneAttack</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>Date</span> <span style=color:#7287fd>date</span><span style=color:#04a5e5>){</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>super</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>date</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTime</span><span style=color:#04a5e5>());</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#acb0be;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#acb0be;font-style:italic>        * This method clones a {@code Date} and manipulates it.
</span></span></span><span style=display:flex><span><span style=color:#acb0be;font-style:italic>        */</span>
</span></span><span style=display:flex><span>    <span style=color:#ea76cb>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>public</span> <span style=color:#7287fd>Date</span> <span style=color:#04a5e5>clone</span><span style=color:#04a5e5>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#7287fd>Date</span> <span style=color:#7287fd>result</span> <span style=color:#04a5e5>=</span> <span style=color:#04a5e5>(</span><span style=color:#7287fd>Date</span><span style=color:#04a5e5>)</span> <span style=color:#8839ef>super</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>clone</span><span style=color:#04a5e5>();</span>
</span></span><span style=display:flex><span>        <span style=color:#7287fd>result</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>setDate</span><span style=color:#04a5e5>(</span>30<span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span>        <span style=color:#7287fd>result</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>setMonth</span><span style=color:#04a5e5>(</span>10<span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span>        <span style=color:#8839ef>return</span> <span style=color:#7287fd>result</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#04a5e5>}</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>}</span>
</span></span></code></pre></div><p>To make the attack work (and show why you shouldn&rsquo;t use clone for defensive copies), let&rsquo;s change the constructor to use the <code>clone()</code>-method of what seems to be a <code>Date</code>-object:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#acb0be;font-style:italic>// Bad practice example. DON&#39;T DO THIS!
</span></span></span><span style=display:flex><span><span style=color:#acb0be;font-style:italic></span><span style=color:#8839ef>public</span> <span style=color:#04a5e5>GeoTag</span><span style=color:#04a5e5>(</span><span style=color:#df8e1d>int</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>,</span> <span style=color:#df8e1d>int</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>Date</span> <span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>,</span> <span style=color:#7287fd>String</span> <span style=color:#7287fd>message</span><span style=color:#04a5e5>)</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>latitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>latitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>longitude</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>longitude</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>timestamp</span> <span style=color:#04a5e5>=</span> <span style=color:#04a5e5>(</span><span style=color:#7287fd>Date</span><span style=color:#04a5e5>)</span> <span style=color:#7287fd>timestamp</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>clone</span><span style=color:#04a5e5>();</span>
</span></span><span style=display:flex><span>    <span style=color:#8839ef>this</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>message</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>message</span><span style=color:#04a5e5>;</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>}</span>
</span></span></code></pre></div><p>Now, it&rsquo;s possible to change the <code>Date</code>-object, which is passed to the constructor, after it is passed:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#7287fd>Calendar</span> <span style=color:#7287fd>calendar</span> <span style=color:#04a5e5>=</span> <span style=color:#7287fd>Calendar</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getInstance</span><span style=color:#04a5e5>();</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>calendar</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>set</span><span style=color:#04a5e5>(</span>1999<span style=color:#04a5e5>,</span> 12<span style=color:#04a5e5>,</span> 24<span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>DateCloneAttack</span> <span style=color:#7287fd>attack</span> <span style=color:#04a5e5>=</span> <span style=color:#8839ef>new</span> <span style=color:#7287fd>DateCloneAttack</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>calendar</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTime</span><span style=color:#04a5e5>());</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>GeoTag</span> <span style=color:#7287fd>tag</span> <span style=color:#04a5e5>=</span> <span style=color:#8839ef>new</span> <span style=color:#7287fd>GeoTag</span><span style=color:#04a5e5>(</span>12<span style=color:#04a5e5>,</span> 14<span style=color:#04a5e5>,</span> <span style=color:#7287fd>attack</span><span style=color:#04a5e5>,</span> <span style=color:#40a02b>&#34;Some message!&#34;</span><span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#7287fd>System</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>out</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>println</span><span style=color:#04a5e5>(</span><span style=color:#40a02b>&#34;GeoTag taken on: &#34;</span><span style=color:#04a5e5>+</span><span style=color:#7287fd>tag</span><span style=color:#04a5e5>.</span><span style=color:#df8e1d>getTimestamp</span><span style=color:#04a5e5>().</span><span style=color:#df8e1d>toLocaleString</span><span style=color:#04a5e5>());</span>
</span></span></code></pre></div><p>This will print out:</p><blockquote><p>GeoTag taken on: 30.10.1999 00:00:00</p></blockquote><p>The lesson here is, that you can&rsquo;t trust the user. If the <code>Date</code>-class would have been <em>finalized</em>, creating a manipulated <code>clone()</code>-method would have been impossible.</p><p>In an actual, real-live example, this attack could smuggle an invalid object around the validity tests and modify it afterwards, leaving the new object in an invalid state. Therefore, check for validity <em>after</em> cloning or recreating your mutable parameters (on the defensive copies).</p><p>Although you might use a mix of both: In the constructor, recreate the object using it&rsquo;s constructor. When giving the object out (in it&rsquo;s getter-method), you can use <code>clone()</code>, because you already have a validated copy of it. But, since cloning objects does not necessarily result in any kind of performance-increase, but rather makes your code more error prone, <strong>you should not use <code>clone()</code> if possible</strong>.</p><h3 id=strings-are-immutable>Strings are immutable</h3><p>You might wonder why we need to make a defensive copy of the <code>Date</code>, but not the <code>String</code>-object. This is, because <code>String</code> itself is immutable. Quoting from it&rsquo;s <a href=http://docs.oracle.com/javase/6/docs/api/java/lang/String.html>JavaDoc</a>:</p><blockquote><p>Strings are constant; their values cannot be changed after they are created. String buffers support mutable strings.
Because <strong>String objects are immutable</strong> they can be shared [&mldr;]</p></blockquote><p>A more detailed explanation might be found on the linked documentation page.</p><h2 id=changing-a-geotag>Changing a <code>GeoTag</code></h2><p>An object that can&rsquo;t be modified is pretty boring. What if you <em>do</em> have legit reasons to change certain fields, for example if you want to make the message editable?</p><p>Let&rsquo;s write a setter method for message that <strong>still leaves the object immutable</strong>:</p><div class=highlight><pre tabindex=0 style=color:#fe640b;background-color:#eff1f5;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8839ef>public</span> <span style=color:#7287fd>GeoTag</span> <span style=color:#04a5e5>setMessage</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>String</span> <span style=color:#7287fd>newMessage</span><span style=color:#04a5e5>)</span> <span style=color:#04a5e5>{</span>
</span></span><span style=display:flex><span>  <span style=color:#8839ef>return</span> <span style=color:#8839ef>new</span> <span style=color:#7287fd>GeoTag</span><span style=color:#04a5e5>(</span><span style=color:#7287fd>getLatitude</span><span style=color:#04a5e5>(),</span> <span style=color:#7287fd>getLongitude</span><span style=color:#04a5e5>(),</span> <span style=color:#7287fd>getTimestamp</span><span style=color:#04a5e5>(),</span> <span style=color:#7287fd>newMessage</span><span style=color:#04a5e5>);</span>
</span></span><span style=display:flex><span><span style=color:#04a5e5>}</span>
</span></span></code></pre></div><p>The setter <strong>does not modify the object</strong> but instead returns a new object with the modified message. This means that references to the original <code>GeoTag</code> are still valid (and will still show the old message), but now there is a new object with the same latitude/longitude/timestamp and a new message.</p><p>Of course this means that any code that is currently working with the old object will not see this change. But remember that this is exactly what we wanted, specifically in a multi-threaded context. In practice, this is rarely a problem because changes to an object require that operations be re-run with the new object anyways. For example, if our <code>GeoTag</code> was being persisted to a database, changing the message would require persisting the change to the database again anyways.</p><h2 id=conclusion>Conclusion</h2><p>Make your <em>value containers</em> immutable. It makes writing <em>correct</em> software much easier.</p><p>Here are the five simple rules to create an immutable object in Java, taken from &ldquo;Effective Java - Second Edition&rdquo;, Chapter 4, Item 15:</p><blockquote><ol><li>Don&rsquo;t provide any methods that modify the object&rsquo;s state.</li><li>Ensure that the class can&rsquo;t be extended.</li><li>Make all fields final.</li><li>Make all fields private.</li><li>Ensure exclusive access to any mutable components (defensive copies)</li></ol></blockquote><p>As a sixth rule: <strong>Document immutability</strong>. If you designed a component to be immutable, document so in the JavaDoc of this class.</p></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Lukas Knuth</div><div class=footer-right><nav><ul><li><a href=/writings>Writings</a></li><li><a href=/about>About</a></li><li><a href=/cv>CV</a></li><li><a href=/imprint>Imprint</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script></html>